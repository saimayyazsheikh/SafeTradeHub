<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Safe Trade Hub ‚Äì Verify Profile</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <a href="index.html" class="logo">SafeTradeHub</a>
    <nav class="header-actions">
      <a class="link" href="auth.html?mode=signin" id="who"></a>
    </nav>
  </div>
</header>

  <main class="main-content">
    <section class="verification-section">
      <div class="container" style="max-width:1200px">
        <!-- Enhanced Header -->
        <div class="verification-header">
          <div class="header-content">
            <h1>Complete Your Verification</h1>
            <p class="header-subtitle">Verify your identity to access all SafeTradeHub features and start selling</p>
          </div>
          <div class="verification-progress">
            <div class="progress-circle" id="progressCircle">
              <span class="progress-text" id="progressText">0%</span>
            </div>
            <div class="progress-info">
              <div class="progress-label">Verification Progress</div>
              <div class="progress-steps" id="progressSteps">0 of 6 steps completed</div>
            </div>
          </div>
        </div>

        <!-- Enhanced Status Summary -->
        <div class="verification-grid">
          <aside class="status-card">
            <div class="card-header">
              <h3>Verification Status</h3>
              <div class="verification-level" id="verificationLevel">Basic</div>
            </div>
            <div class="status-summary">
              <div class="status-item" id="emailStatus">
                <div class="status-content">
                  <div class="status-title">Email Verification</div>
                  <div class="status-desc">Email address verified</div>
                </div>
                <div class="status-badge pending">Pending</div>
              </div>
              <div class="status-item" id="phoneStatus">
                <div class="status-content">
                  <div class="status-title">Phone Verification</div>
                  <div class="status-desc">Phone number verified</div>
                </div>
                <div class="status-badge pending">Pending</div>
              </div>
              <div class="status-item" id="addressStatus">
                <div class="status-content">
                  <div class="status-title">Address Verification</div>
                  <div class="status-desc">Residential address</div>
                </div>
                <div class="status-badge pending">Pending</div>
              </div>
              <div class="status-item" id="identityStatus">
                <div class="status-content">
                  <div class="status-title">Identity Verification</div>
                  <div class="status-desc">CNIC & Selfie verification</div>
                </div>
                <div class="status-badge pending">Pending</div>
              </div>
              <div class="status-item" id="shopStatus" style="display: none;">
                <div class="status-content">
                  <div class="status-title">Shop Verification</div>
                  <div class="status-desc">Business verification</div>
                </div>
                <div class="status-badge pending">Pending</div>
              </div>
            </div>
            <div class="verification-benefits">
              <h4>Verification Benefits</h4>
              <ul>
                <li>‚Ä¢ Access to all marketplace features</li>
                <li>‚Ä¢ Higher trust score from buyers</li>
                <li>‚Ä¢ Priority customer support</li>
                <li>‚Ä¢ Advanced seller tools</li>
              </ul>
            </div>
          </aside>

          <div class="steps-card">
            <!-- Step 1: Email Verification -->
            <div class="verification-step" id="emailStep">
              <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-content">
                  <h3>Email Verification</h3>
                  <p class="step-description">Verify your email address to secure your account</p>
                </div>
                <div class="step-status">
                  <span id="badgeEmail" class="status-badge pending">Pending</span>
                </div>
              </div>
              <div class="step-body">
                <div class="step-info">
                  <div class="info-content">
                    <p>We've sent a verification link to your email address. Please check your inbox and click the link to verify your email.</p>
                    <p class="email-address" id="userEmail">user@example.com</p>
                  </div>
                </div>
                <div class="step-actions">
                  <button class="btn secondary" id="resendEmailBtn">
                    Resend Email
                  </button>
                  <button class="btn primary" id="refreshEmailBtn">
                    Check Status
                  </button>
                </div>
                <div class="step-help">
                  <p><strong>Tip:</strong> Check your spam folder if you don't see the email</p>
                </div>
              </div>
            </div>

            <!-- Step 2: Phone Verification -->
            <div class="verification-step" id="phoneStep">
              <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-content">
                  <h3>Phone Verification</h3>
                  <p class="step-description">Verify your phone number with SMS OTP</p>
                </div>
                <div class="step-status">
                  <span id="badgePhone" class="status-badge pending">Pending</span>
                </div>
              </div>
              <div class="step-body">
                <div class="step-info">
                  <div class="info-content">
                    <p>Enter your phone number to receive a verification code via SMS. This helps us verify your identity and contact you if needed.</p>
                  </div>
                </div>
                <div class="phone-form">
                  <div class="form-group">
                    <label for="phoneInput">Phone Number</label>
                    <div class="phone-input-group">
                      <div class="country-code">+92</div>
                      <input id="phoneInput" type="tel" placeholder="300 123 4567" class="phone-input" />
                    </div>
                    <small class="form-help">Enter your Pakistani phone number</small>
                  </div>
                  
                  <div class="form-group">
                    <label for="otpCode">Verification Code</label>
                    <input id="otpCode" type="text" placeholder="Enter 6-digit code" maxlength="6" class="otp-input" />
                    <small class="form-help">Enter the 6-digit code sent to your phone</small>
                  </div>
                  
                  <div class="form-actions">
                    <button class="btn primary" id="sendOtpBtn">
                      Send OTP
                    </button>
                    <button class="btn secondary" id="verifyOtpBtn" style="display:none;">
                      Verify Code
                    </button>
                    <button class="btn secondary" id="resendOtpBtn" style="display:none;">
                      Resend OTP
                    </button>
                  </div>
                </div>
                <div id="recaptcha-container"></div>
                <div class="step-help">
                  <p><strong>Note:</strong> SMS charges may apply. Code expires in 5 minutes.</p>
                </div>
              </div>
            </div>

            <!-- Step 3: Address Verification -->
            <div class="verification-step" id="addressStep">
              <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-content">
                  <h3>Address Verification</h3>
                  <p class="step-description">Provide your residential address for verification</p>
                </div>
                <div class="step-status">
                  <span id="badgeAddress" class="status-badge pending">Pending</span>
                </div>
              </div>
              <div class="step-body">
                <div class="step-info">
                  <div class="info-content">
                    <p>Please provide your complete residential address. This information is used for identity verification and delivery purposes.</p>
                  </div>
                </div>
                <div class="address-form">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="streetAddress">Street Address</label>
                      <input id="streetAddress" type="text" placeholder="123 Main Street, Apartment 4B" />
                    </div>
                  </div>
                  <div class="form-row two">
                    <div class="form-group">
                      <label for="city">City</label>
                      <input id="city" type="text" placeholder="Karachi" />
                    </div>
                    <div class="form-group">
                      <label for="state">State/Province</label>
                      <input id="state" type="text" placeholder="Sindh" />
                    </div>
                  </div>
                  <div class="form-row two">
                    <div class="form-group">
                      <label for="postalCode">Postal Code</label>
                      <input id="postalCode" type="text" placeholder="75000" />
                    </div>
                    <div class="form-group">
                      <label for="country">Country</label>
                      <select id="country">
                        <option value="PK">Pakistan</option>
                        <option value="US">United States</option>
                        <option value="UK">United Kingdom</option>
                        <option value="CA">Canada</option>
                        <option value="AU">Australia</option>
                        <option value="IN">India</option>
                        <option value="BD">Bangladesh</option>
                      </select>
                    </div>
                  </div>
                  <div class="location-section">
                    <div class="location-header">
                      <h4>Location Verification</h4>
                      <p>Please share your current location to verify your address</p>
                    </div>
                    <div class="location-input">
                      <input id="latlng" type="text" placeholder="Latitude, Longitude" readonly />
                      <button class="btn secondary" id="useLocationBtn">
                        Use My Location
                      </button>
                    </div>
                    <small class="form-help">Your location data is encrypted and used only for verification purposes</small>
                  </div>
                  <div class="form-actions">
                    <button class="btn primary" id="saveAddressBtn">
                      Submit Address
                    </button>
                  </div>
                </div>
                <div class="step-help">
                  <p><strong>Privacy:</strong> Your address information is encrypted and only used for verification</p>
                </div>
              </div>
            </div>

            <!-- Step 4: Identity Verification -->
            <div class="verification-step" id="identityStep">
              <div class="step-header">
                <div class="step-number">4</div>
                <div class="step-content">
                  <h3>Identity Verification</h3>
                  <p class="step-description">Upload your CNIC and selfie for identity verification</p>
                </div>
                <div class="step-status">
                  <span id="badgeCnic" class="status-badge pending">Pending</span>
                </div>
              </div>
              <div class="step-body">
                <div class="step-info">
                  <div class="info-content">
                    <p>Upload clear photos of your CNIC (front and back) and a selfie. Our admin team will review these documents to verify your identity.</p>
                  </div>
                </div>
                
                <!-- CNIC Upload Section -->
                <div class="document-upload-section">
                  <h4>CNIC Document Upload</h4>
                  <div class="upload-grid">
                    <div class="upload-item">
                      <div class="upload-area" id="cnicFrontArea">
                        <div class="upload-text">
                          <h5>CNIC Front</h5>
                          <p>Upload the front side of your CNIC</p>
                        </div>
                        <input id="cnicFront" type="file" accept="image/*" hidden />
                        <button class="upload-btn" onclick="document.getElementById('cnicFront').click()">
                          Choose File
                        </button>
                      </div>
                      <div class="file-preview" id="cnicFrontPreview"></div>
                    </div>
                    <div class="upload-item">
                      <div class="upload-area" id="cnicBackArea">
                        <div class="upload-text">
                          <h5>CNIC Back</h5>
                          <p>Upload the back side of your CNIC</p>
                        </div>
                        <input id="cnicBack" type="file" accept="image/*" hidden />
                        <button class="upload-btn" onclick="document.getElementById('cnicBack').click()">
                          Choose File
                        </button>
                      </div>
                      <div class="file-preview" id="cnicBackPreview"></div>
                    </div>
                  </div>
                </div>

                <!-- Selfie Upload Section -->
                <div class="document-upload-section">
                  <h4>Selfie Upload</h4>
                  <div class="upload-item single">
                    <div class="upload-area" id="selfieArea">
                      <div class="upload-text">
                        <h5>Live Selfie Required</h5>
                        <p>You must take a live selfie using your camera for identity verification</p>
                      </div>
                      <div class="camera-section" style="position: relative;">
                        <video id="cameraPreview" width="300" height="225" autoplay style="display:none; border-radius: 8px; margin: 10px 0; border: 2px solid #3b82f6;"></video>
                        <canvas id="photoCanvas" width="300" height="225" style="display:none;"></canvas>
                        <div id="capturedImageDisplay" style="display:none; text-align: center; margin: 10px 0;">
                          <img id="capturedImage" style="max-width: 300px; border-radius: 8px; border: 3px solid #22c55e; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">
                        </div>
                      </div>
                      <div class="camera-controls">
                        <button class="btn primary" id="startCameraBtn">
                          Start Camera
                        </button>
                        <button class="btn primary" id="capturePhotoBtn" style="display:none;">
                          Capture Photo
                        </button>
                        <button class="btn secondary" id="retakePhotoBtn" style="display:none;">
                          Retake
                        </button>
                      </div>
                    </div>
                    <div class="file-preview" id="selfiePreview"></div>
                  </div>
                </div>

                <div class="upload-requirements">
                  <h5>Upload Requirements</h5>
                  <ul>
                    <li>‚Ä¢ Clear, high-quality images (minimum 800x600px)</li>
                    <li>‚Ä¢ All text should be clearly readable</li>
                    <li>‚Ä¢ Good lighting and no shadows</li>
                    <li>‚Ä¢ File size under 5MB per image</li>
                    <li>‚Ä¢ Supported formats: JPG, PNG</li>
                  </ul>
                </div>

                <div class="form-actions">
                  <button class="btn primary" id="uploadCnicBtn">
                    Upload Documents
                  </button>
                </div>

                <div class="step-help">
                  <p><strong>Security:</strong> Your documents are encrypted and only accessible to our verification team</p>
                </div>
              </div>
            </div>

            <!-- Step 5: Shop Verification (Sellers Only) -->
            <div class="verification-step" id="shopStep" style="display:none">
              <div class="step-header">
                <div class="step-number">5</div>
                <div class="step-content">
                  <h3>Business Verification</h3>
                  <p class="step-description">Verify your business to start selling on SafeTradeHub</p>
                </div>
                <div class="step-status">
                  <span id="badgeShop" class="status-badge pending">Pending</span>
                </div>
              </div>
              <div class="step-body">
                <div class="step-info">
                  <div class="info-icon">üè™</div>
                  <div class="info-content">
                    <p>As a seller, you need to verify your business to start listing products. This helps build trust with buyers and ensures compliance with our marketplace policies.</p>
                  </div>
                </div>
                
                <div class="shop-form">
                  <h4>Business Business Information</h4>
                  <div class="form-row two">
                    <div class="form-group">
                      <label for="shopName">Business Name</label>
                      <input id="shopName" type="text" placeholder="My Store Name" />
                    </div>
                    <div class="form-group">
                      <label for="businessType">Business Type</label>
                      <select id="businessType">
                        <option value="">Select Business Type</option>
                        <option value="individual">Individual Seller</option>
                        <option value="retail">Retail Store</option>
                        <option value="wholesale">Wholesale Business</option>
                        <option value="online">Online Store</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="shopAddr">Business Address</label>
                    <textarea id="shopAddr" rows="3" placeholder="Complete business address including city and postal code"></textarea>
                  </div>
                  
                  <!-- Business Location Verification -->
                  <div class="location-verification-section">
                    <h4>Business Location Verification</h4>
                    <p>Please share your business location to verify your address</p>
                    <div class="location-controls">
                      <button class="btn secondary" id="getBusinessLocationBtn">
                        Use My Location
                      </button>
                      <div id="businessLocationStatus" class="location-status"></div>
                    </div>
                    <div id="businessLocationDisplay" class="location-display" style="display: none;">
                      <div class="location-info">
                        <h6>Business Location Captured</h6>
                        <p id="businessLocationCoords"></p>
                        <small id="businessLocationTime"></small>
                      </div>
                    </div>
                  </div>
                  
                  <div class="form-row two">
                    <div class="form-group">
                      <label for="businessPhone">Business Phone</label>
                      <input id="businessPhone" type="tel" placeholder="+92 300 123 4567" />
                    </div>
                    <div class="form-group">
                      <label for="businessEmail">Business Email</label>
                      <input id="businessEmail" type="email" placeholder="business@example.com" />
                    </div>
                  </div>
                </div>

                <div class="document-upload-section">
                  <h4>Business Photos</h4>
                  <div class="upload-grid">
                    <div class="upload-item">
                      <div class="upload-area" id="shopPhotosArea">
                        <div class="upload-icon">Photo</div>
                        <div class="upload-text">
                          <h5>Shop Photos</h5>
                          <p>Upload photos of your physical store or workspace</p>
                        </div>
                        <input id="shopPhotos" type="file" accept="image/*" multiple hidden />
                        <button class="upload-btn" onclick="document.getElementById('shopPhotos').click()">
                          Choose Photos
                        </button>
                      </div>
                      <div class="file-preview" id="shopPhotosPreview"></div>
                    </div>
                  </div>
                </div>

                <div class="document-upload-section">
                  <h4>Business Documents</h4>
                  <div class="upload-grid">
                    <div class="upload-item">
                      <div class="upload-area" id="shopDocsArea">
                        <div class="upload-icon">Document</div>
                        <div class="upload-text">
                          <h5>Business Documents</h5>
                          <p>Upload business license, registration, or utility bills</p>
                        </div>
                        <input id="shopDocs" type="file" multiple hidden />
                        <button class="upload-btn" onclick="document.getElementById('shopDocs').click()">
                          Choose Documents
                        </button>
                      </div>
                      <div class="file-preview" id="shopDocsPreview"></div>
                    </div>
                  </div>
                </div>

                <div class="upload-requirements">
                  <h5>Document Requirements</h5>
                  <ul>
                    <li>‚Ä¢ Business registration certificate or license</li>
                    <li>‚Ä¢ Utility bill (electricity, gas, water) in business name</li>
                    <li>‚Ä¢ Bank statement or tax document</li>
                    <li>‚Ä¢ Clear photos of your physical store/workspace</li>
                    <li>‚Ä¢ All documents should be recent (within 6 months)</li>
                  </ul>
                </div>

                <div class="form-actions">
                  <button class="btn primary" id="uploadShopBtn">
                    Submit Business Verification
                  </button>
                </div>

                <div class="step-help">
                  <p><strong>Note:</strong> Business verification typically takes 1-3 business days</p>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer"><div class="container"><p>All Rights Reserved By Safe Trade Hub</p></div></footer>

<script>
/* Firebase init */
const firebaseConfig = {
  apiKey: "AIzaSyBK-1VZZImDnjmRCXBEzyLAq6AthTZ8yIs",
  authDomain: "safe-trade-hub-a57cb.firebaseapp.com",
  projectId: "safe-trade-hub-a57cb",
  storageBucket: "safe-trade-hub-a57cb.appspot.com",   // <-- fix
  messagingSenderId: "509522351934",
  appId: "1:509522351934:web:a9f5624cded8f7a6d93e6f",
  measurementId: "G-060FYYP5DD"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

let user, userRef, userData, confirmationResult;

/* Helpers */
const $ = (id)=> document.getElementById(id);
const badge = (id, ok)=> { const b=$(id); b.textContent = ok?'Verified':'Pending'; b.className = 'badge ' + (ok?'ok':''); };
function statusListRender(v){
  const items = [
    ['Email', v.email],
    ['Phone', v.phone],
    ['Address', v.address?.verified || v.address?.submitted],
    ['CNIC', v.cnic?.verified || v.cnic?.submitted],
    ['Selfie', v.selfie?.verified || v.selfie?.submitted],
    ['Shop (Seller only)', v.shop?.verified || v.shop?.submitted]
  ].map(([label, ok])=> `<li><span class="dot ${ok?'ok':''}"></span>${label}: <strong>${ok?'Submitted/OK':'Pending'}</strong></li>`).join('');
  $('statusList').innerHTML = items;
}

/* Enhanced UI Update Functions */
function updateVerificationUI(verification) {
  // Update status badges
  updateBadge('badgeEmail', verification.email);
  updateBadge('badgePhone', verification.phone);
  updateBadge('badgeAddress', verification.address?.verified || verification.address?.submitted);
  updateBadge('badgeCnic', verification.cnic?.verified || verification.cnic?.submitted);
  updateBadge('badgeShop', verification.shop?.verified || verification.shop?.submitted);
  
  // Update status items
  updateStatusItem('emailStatus', verification.email, 'Email', 'Email address verified');
  updateStatusItem('phoneStatus', verification.phone, 'Phone', 'Phone number verified');
  updateStatusItem('addressStatus', verification.address?.verified || verification.address?.submitted, 'Address', 'Residential address');
  updateStatusItem('identityStatus', verification.cnic?.verified || verification.cnic?.submitted, 'Identity', 'CNIC & Selfie verification');
  updateStatusItem('shopStatus', verification.shop?.verified || verification.shop?.submitted, 'Shop', 'Business verification');
  
  // Update verification level
  const completedSteps = Object.values(verification).filter(v => v === true || (v && (v.verified || v.submitted))).length;
  const level = completedSteps >= 4 ? 'Verified' : completedSteps >= 2 ? 'Partial' : 'Basic';
  $('verificationLevel').textContent = level;
}

function updateStatusItem(elementId, isVerified, title, description) {
  const element = $(elementId);
  if (!element) return;
  
  const badge = element.querySelector('.status-badge');
  if (badge) {
    badge.textContent = isVerified ? 'Verified' : 'Pending';
    badge.className = `status-badge ${isVerified ? 'verified' : 'pending'}`;
  }
}

function updateProgress(verification) {
  const steps = [
    verification.email,
    verification.phone,
    verification.address?.verified || verification.address?.submitted,
    verification.cnic?.verified || verification.cnic?.submitted,
    verification.shop?.verified || verification.shop?.submitted
  ];
  
  const completedSteps = steps.filter(step => step === true || (step && (step.verified || step.submitted))).length;
  const totalSteps = userData?.role === 'Seller' ? 5 : 4;
  const percentage = Math.round((completedSteps / totalSteps) * 100);
  
  $('progressText').textContent = `${percentage}%`;
  $('progressSteps').textContent = `${completedSteps} of ${totalSteps} steps completed`;
  
  // Update progress circle background
  const circle = $('progressCircle');
  if (circle) {
    circle.style.background = `conic-gradient(#10b981 ${percentage * 3.6}deg, rgba(255, 255, 255, 0.2) 0deg)`;
  }
}

function updateBadge(id, isVerified) {
  const element = $(id);
  if (!element) return;
  
  element.textContent = isVerified ? 'Verified' : 'Pending';
  element.className = `status-badge ${isVerified ? 'verified' : 'pending'}`;
}

/* Load user & doc */
auth.onAuthStateChanged(async (u)=>{
  if(!u){ location.href = 'auth.html?mode=signin'; return; }
  user = u;
  $('who').textContent = u.email || u.phoneNumber || u.uid;
  userRef = db.collection('users').doc(u.uid);
  const snap = await userRef.get();
  userData = snap.exists ? snap.data() : null;
  if (!userData){
    // Create shell if missing (e.g., signed in user before join flow)
    userData = {
      displayName: u.displayName || '',
      email: u.email || '',
      phone: u.phoneNumber || '',
      role: 'Buyer',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      verification: {
        email: !!u.email && u.emailVerified,
        phone: !!u.phoneNumber,
        address: { submitted:false, verified:false },
        cnic:    { submitted:false, verified:false },
        selfie:  { submitted:false, verified:false },
        shop:    { submitted:false, verified:false }
      },
      status: 'pending'
    };
    await userRef.set(userData, { merge:true });
  }
  // prefill phone & badges
  if (userData.phone) $('phoneInput').value = userData.phone;
  const v = userData.verification || {};
  
  // Update new UI elements
  updateVerificationUI(v);
  updateProgress(v);
  
  // Show seller verification if user is seller
  if ((userData.role||'Buyer') === 'Seller'){ 
    $('shopStep').style.display = 'block';
    $('shopStatus').style.display = 'flex';
  }
  
  // Update user email display
  if (user.email) {
    $('userEmail').textContent = user.email;
  }
});

// ===== Email verification (drop-in replacement) =====
$('resendEmailBtn').addEventListener('click', async ()=>{
  try{
    const u = firebase.auth().currentUser;
    if(!u || !u.email) return alert('Sign in with an email account first.');
    const actionCodeSettings = {
      url: 'http://127.0.0.1:5500/verify.html?mode=verifyEmail',
      handleCodeInApp: false
    };
    await u.sendEmailVerification(actionCodeSettings);
    alert('Verification email sent. Check Inbox/Spam.');
  }catch(e){
    console.error('sendEmailVerification error:', e);
    alert(`${e.code || ''} ${e.message || e}`);
  }
});

// In your onAuthStateChanged block (after you set userRef/userData), keep/ensure this handler:
/* --- Email link handler: robust to timing/race --- */
(async function handleEmailLinkIfPresent(){
  const params = new URLSearchParams(location.search);
  const mode = params.get('mode');
  const oobCode = params.get('oobCode');
  if (mode !== 'verifyEmail' || !oobCode) return;

  try {
    // Mark the email verified with Firebase
    await auth.applyActionCode(oobCode);
    await auth.currentUser?.reload();

    // Write verification=true without depending on userRef timing
    const uid = auth.currentUser?.uid;
    if (uid) {
      await db.collection('users').doc(uid).set({
        verification: { email: true }
      }, { merge: true });
      badge('badgeEmail', true);
    }

    alert('Email verified.');
  } catch (e) {
    console.error('applyActionCode error:', e);
    alert(`${e.code || ''} ${e.message || e}`);
  } finally {
    // Clean URL so it doesn't re-run after reload
    const url = new URL(location.href);
    ['mode','oobCode','apiKey','lang','continueUrl'].forEach(k => url.searchParams.delete(k));
    history.replaceState({}, '', url.toString());
  }
})();


//Email Resend
$('resendEmailBtn').addEventListener('click', async ()=>{
  try{
    const u = firebase.auth().currentUser;
    if(!u || !u.email) return alert('Sign in with an email account first.');

    // Use the exact origin you are on (127.0.0.1 or localhost)
    const base = location.origin; // e.g. http://127.0.0.1:5500 or http://localhost:5500
    const actionCodeSettings = {
      url: `${base}/verify.html?mode=verifyEmail`,
      handleCodeInApp: false
    };

    await u.sendEmailVerification(actionCodeSettings);
    alert('Verification email sent. Check Inbox/Spam.');
  }catch(e){
    console.error('sendEmailVerification error:', e);
    alert(`${e.code || ''} ${e.message || e}`);
  }
});


/* ===== Phone OTP (REPLACE YOUR OLD BLOCK WITH THIS) ===== */
let appVerifier;

function initRecaptcha(){
  if (!appVerifier) {
    appVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });
    appVerifier.render(); // important on localhost
  }
}

function requireE164(p){
  const v = (p || '').trim();
  if (!v.startsWith('+')) throw new Error('Enter phone in international format, e.g. +92xxxxxxxxxx');
  return v;
}

$('sendOtpBtn').addEventListener('click', async ()=>{
  try{
    const u = firebase.auth().currentUser;
    if(!u) return alert('Please sign in first.');
    initRecaptcha();
    const phone = requireE164($('phoneInput').value);
    confirmationResult = await u.linkWithPhoneNumber(phone, appVerifier);
    $('otpRow').style.display = 'grid';
    alert('OTP sent.');
  }catch(e){
    alert(e.message);
  }
});

$('verifyOtpBtn').addEventListener('click', async ()=>{
  try{
    if(!confirmationResult) return alert('Please request an OTP first.');
    const code = $('otpCode').value.trim();
    const cred = await confirmationResult.confirm(code); // completes linking
    await cred.user.reload();
    await userRef.set({
      phone: cred.user.phoneNumber,
      verification: { ...userData.verification, phone: true }
    }, { merge:true });
    badge('badgePhone', true);
    alert('Phone verified.');
  }catch(e){
    alert(e.message);
  }
});

/* Address */
$('useLocationBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Geolocation not available.'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    $('latlng').value = `${pos.coords.latitude.toFixed(6)}, ${pos.coords.longitude.toFixed(6)}`;
  }, err=> alert(err.message), { enableHighAccuracy:true, timeout:10000 });
});

/* Business Location */
let businessLocationData = null;

document.getElementById('getBusinessLocationBtn')?.addEventListener('click', () => {
  if (!navigator.geolocation) {
    alert('Geolocation not available on this device.');
    return;
  }
  
  const statusDiv = document.getElementById('businessLocationStatus');
  const displayDiv = document.getElementById('businessLocationDisplay');
  const coordsP = document.getElementById('businessLocationCoords');
  const timeSmall = document.getElementById('businessLocationTime');
  
  statusDiv.innerHTML = '<span style="color: #3b82f6;">Getting location...</span>';
  
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const lat = position.coords.latitude.toFixed(6);
      const lng = position.coords.longitude.toFixed(6);
      const timestamp = new Date().toLocaleString();
      
      businessLocationData = {
        latitude: lat,
        longitude: lng,
        timestamp: timestamp,
        accuracy: position.coords.accuracy
      };
      
      // Show success status
      statusDiv.innerHTML = '<span style="color: #22c55e;">‚úì Location captured successfully</span>';
      
      // Show location display
      coordsP.textContent = `Coordinates: ${lat}, ${lng}`;
      timeSmall.textContent = `Captured: ${timestamp}`;
      displayDiv.style.display = 'block';
      
      // Hide the button after successful capture
      document.getElementById('getBusinessLocationBtn').style.display = 'none';
      
    },
    (error) => {
      let errorMessage = 'Unable to get location. ';
      switch (error.code) {
        case error.PERMISSION_DENIED:
          errorMessage += 'Please allow location access.';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage += 'Location information unavailable.';
          break;
        case error.TIMEOUT:
          errorMessage += 'Location request timed out.';
          break;
        default:
          errorMessage += 'Unknown error occurred.';
          break;
      }
      statusDiv.innerHTML = `<span style="color: #ef4444;">${errorMessage}</span>`;
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
});

function getBusinessLocationData() {
  return businessLocationData;
}
$('saveAddressBtn').addEventListener('click', async ()=>{
  const u = firebase.auth().currentUser; if(!u) return alert('Please sign in');
  
  // Get values from new form structure
  const streetAddress = $('streetAddress').value.trim();
  const city = $('city').value.trim();
  const state = $('state').value.trim();
  const postalCode = $('postalCode').value.trim();
  const country = $('country').value;
  const latlng = $('latlng').value.trim();
  
  if (!streetAddress || !city || !state || !postalCode) {
    return alert('Please fill in all required address fields');
  }
  
  const fullAddress = `${streetAddress}, ${city}, ${state} ${postalCode}, ${country}`;
  const [lat,lng] = latlng ? latlng.split(',').map(s=>parseFloat(s)) : [null,null];
  
  try {
    await userRef.update({
      'verification.address': {
        submitted: true,
        verified: false,
        streetAddress,
        city,
        state,
        postalCode,
        country,
        fullAddress,
        lat: lat || null,
        lng: lng || null,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      }
    });
    
    // Update UI
    updateBadge('badgeAddress', true);
    updateStatusItem('addressStatus', true, 'Address', 'Residential address');
    updateProgress(userData.verification);
    
    alert('Address submitted for verification.');
  } catch (e) {
    alert(e.message);
  }
});

// File upload preview functionality
function setupFilePreview(inputId, previewId) {
  const input = $(inputId);
  const preview = $(previewId);
  
  if (!input || !preview) return;
  
  input.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.innerHTML = `<img src="${e.target.result}" alt="Preview" />`;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
}

// Setup file previews for all upload inputs
setupFilePreview('cnicFront', 'cnicFrontPreview');
setupFilePreview('cnicBack', 'cnicBackPreview');
setupFilePreview('selfie', 'selfiePreview');

// Multiple file preview for shop photos and docs
function setupMultipleFilePreview(inputId, previewId) {
  const input = $(inputId);
  const preview = $(previewId);
  
  if (!input || !preview) return;
  
  input.addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    if (files.length > 0) {
      preview.innerHTML = files.map(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML += `<img src="${e.target.result}" alt="Preview" />`;
        };
        reader.readAsDataURL(file);
        return `<div class="file-item">${file.name}</div>`;
      }).join('');
      preview.style.display = 'block';
    }
  });
}

setupMultipleFilePreview('shopPhotos', 'shopPhotosPreview');
setupMultipleFilePreview('shopDocs', 'shopDocsPreview');

// Enhanced CNIC upload handler
$('uploadCnicBtn').addEventListener('click', async ()=>{
  const u = firebase.auth().currentUser; if(!u) return alert('Please sign in');
  
  const cnicFront = $('cnicFront')?.files?.[0];
  const cnicBack = $('cnicBack')?.files?.[0];
  const selfie = $('selfie')?.files?.[0];
  
  if (!cnicFront || !cnicBack || !selfie) {
    return alert('Please upload all required documents: CNIC front, CNIC back, and selfie');
  }
  
  try {
    // Upload files to Cloudinary (you'll need to implement this)
    const frontUrl = await uploadToCloudinary(cnicFront);
    const backUrl = await uploadToCloudinary(cnicBack);
    const selfieUrl = await uploadToCloudinary(selfie);
    
    await userRef.update({
      'verification.cnic': {
        submitted: true,
        verified: false,
        frontUrl,
        backUrl,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      },
      'verification.selfie': {
        submitted: true,
        verified: false,
        url: selfieUrl,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      }
    });
    
    // Update UI
    updateBadge('badgeCnic', true);
    updateStatusItem('identityStatus', true, 'Identity', 'CNIC & Selfie verification');
    updateProgress(userData.verification);
    
    alert('Identity documents submitted for verification.');
  } catch (e) {
    alert(e.message);
  }
});

// Enhanced shop upload handler
$('uploadShopBtn').addEventListener('click', async ()=>{
const u = firebase.auth().currentUser; if(!u) return alert('Please sign in');
  
  const shopName = $('shopName').value.trim();
  const businessType = $('businessType').value;
  const shopAddr = $('shopAddr').value.trim();
  const businessPhone = $('businessPhone').value.trim();
  const businessEmail = $('businessEmail').value.trim();
  const shopPhotos = Array.from($('shopPhotos')?.files || []);
  const shopDocs = Array.from($('shopDocs')?.files || []);
  
  if (!shopName || !businessType || !shopAddr) {
    return alert('Please fill in all required business information');
  }
  
  // Check if business location is captured (mandatory)
  const locationData = getBusinessLocationData();
  if (!locationData) {
    return alert('Please capture your business location using "Use My Location" button. This is mandatory for verification.');
  }
  
  if (shopPhotos.length === 0 || shopDocs.length === 0) {
    return alert('Please upload at least one shop photo and one business document');
  }
  
  try {
    // Upload files to Cloudinary
    const photoUrls = await Promise.all(shopPhotos.map(file => uploadToCloudinary(file)));
    const docUrls = await Promise.all(shopDocs.map(file => uploadToCloudinary(file)));
    
    await userRef.update({
      'verification.shop': {
        submitted: true,
        verified: false,
        shopName,
        businessType,
        shopAddr,
        businessPhone,
        businessEmail,
        photoUrls,
        docUrls,
        location: {
          latitude: locationData.latitude,
          longitude: locationData.longitude,
          timestamp: locationData.timestamp,
          accuracy: locationData.accuracy
        },
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      }
    });
    
    // Update UI
    updateBadge('badgeShop', true);
    updateStatusItem('shopStatus', true, 'Shop', 'Business verification');
    updateProgress(userData.verification);
    
    alert('Business verification submitted for review.');
  } catch (e) {
    alert(e.message);
  }
});

// Placeholder for Cloudinary upload function
async function uploadToCloudinary(file) {
  // This is a placeholder - you'll need to implement actual Cloudinary upload
  // For now, return a mock URL
  return `https://res.cloudinary.com/your-cloud-name/image/upload/v1234567890/${file.name}`;
}
</script>

<style>
/* light UI helpers reusing your palette */
.verify-grid{ display:grid; grid-template-columns: 320px 1fr; gap:20px; }
@media (max-width: 980px){ .verify-grid{ grid-template-columns:1fr; } }
.card{ background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px; }
.form-card{ background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px; }
.form-card .form-row{ margin-bottom:12px; }
.form-row.two{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.form-row input, .form-row textarea{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
.radio{ display:flex; align-items:center; gap:8px; margin-right:12px; }

.step{ border:1px dashed #e6e9f4; border-radius:14px; padding:12px; margin-bottom:14px; }
.step-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.step-body{ margin-top:10px; display:grid; gap:10px; }

.badge{ background:#fff3cd; color:#7a5d00; border:1px solid #ffe69c; padding:4px 8px; border-radius:999px; font-weight:700; }
.badge.ok{ background:#dcfce7; color:#14532d; border-color:#86efac; }

.status-list{ list-style:none; padding:0; margin:0; display:grid; gap:8px; }
.status-list .dot{ width:10px; height:10px; border-radius:50%; background:#cbd5e1; display:inline-block; margin-right:8px; }
.status-list .dot.ok{ background:#22c55e; }
.muted{ color:var(--muted); }
</style>

<!-- Cloudinary helpers -->
<script>
  // ---- Cloudinary config (YOUR values) ----
  const CLOUD_NAME = "dfkeplyzn";       // your cloud name
  const UPLOAD_PRESET = "sth_unsigned"; // your unsigned preset

  function ensureImage(file, maxMB=8){
    if(!file) throw new Error('Please select a file');
    if(!/^image\//.test(file.type)) throw new Error('Only image files allowed');
    if(file.size > maxMB*1024*1024) throw new Error(`Max ${maxMB}MB per file`);
  }

  async function uploadToCloudinary(file, folder){
    if(!file) throw new Error('No file selected');
    const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`;
    const fd  = new FormData();
    fd.append('upload_preset', UPLOAD_PRESET);
    fd.append('file', file);
    if (folder) fd.append('folder', folder);

    const res = await fetch(url, { method:'POST', body: fd });
    const json = await res.json();
    if(!res.ok) throw new Error(json?.error?.message || 'Upload failed');
    return { url: json.secure_url, id: json.public_id };
  }

  async function handleCNICUpload(frontFile, backFile, uid){
    ensureImage(frontFile); ensureImage(backFile);
    const base = `kyc/${uid}/cnic`;
    const front = await uploadToCloudinary(frontFile, `${base}`);
    const back  = await uploadToCloudinary(backFile,  `${base}`);

    await db.collection('users').doc(uid).set({
      verification: {
        cnic: {
          submitted: true, verified: false,
          frontUrl: front.url, backUrl: back.url,
          frontId: front.id,   backId: back.id
        }
      },
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    alert('CNIC uploaded');
  }

  async function handleSelfieUpload(selfieFile, uid){
    ensureImage(selfieFile);
    const base = `kyc/${uid}/selfie`;
    const self = await uploadToCloudinary(selfieFile, base);

    await db.collection('users').doc(uid).set({
      verification: { selfie: { submitted:true, verified:false, url:self.url, id:self.id } },
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    alert('Selfie uploaded');
  }

  async function handleShopUpload(photoFiles, docFiles, uid){
    const base = `kyc/${uid}/shop`;
    const photoUrls=[], photoIds=[], docUrls=[], docIds=[];

    for (const f of photoFiles){ ensureImage(f,10); const {url,id}=await uploadToCloudinary(f, `${base}/photos`); photoUrls.push(url); photoIds.push(id); }
    for (const f of docFiles){ const {url,id}=await uploadToCloudinary(f, `${base}/docs`); docUrls.push(url); docIds.push(id); }

    // include name/address from inputs
    const name = document.getElementById('shopName')?.value?.trim() || null;
    const address = document.getElementById('shopAddr')?.value?.trim() || null;

    await db.collection('users').doc(uid).set({
      verification: {
        shop: {
          submitted:true, verified:false,
          name, address,
          photoUrls, docUrls, photoIds, docIds
        }
      },
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

    alert('Shop files uploaded');
  }
</script>

<!-- Wire UI ‚Üí Cloudinary handlers -->
<script>
  const byId = (x)=>document.getElementById(x);

  // CNIC
  byId('uploadCnicBtn')?.addEventListener('click', async ()=>{
    const u = firebase.auth().currentUser; if(!u) return alert('Please sign in');
    const front = byId('cnicFront')?.files?.[0];
    const back  = byId('cnicBack')?.files?.[0];
    try { await handleCNICUpload(front, back, u.uid); } catch(e){ alert(e.message); }
  });

  // Selfie
  byId('uploadSelfieBtn')?.addEventListener('click', async ()=>{
    const u = firebase.auth().currentUser; if(!u) return alert('Please sign in');
    const f = byId('selfie')?.files?.[0];
    try { await handleSelfieUpload(f, u.uid); } catch(e){ alert(e.message); }
  });

  // Shop (seller only)
  byId('uploadShopBtn')?.addEventListener('click', async ()=>{
    const u = firebase.auth().currentUser; if(!u) return alert('Please sign in');
    const photos = Array.from(byId('shopPhotos')?.files || []);
    const docs   = Array.from(byId('shopDocs')?.files   || []);
    try { await handleShopUpload(photos, docs, u.uid); } catch(e){ alert(e.message); }
  });
</script>

<!-- Camera Functionality for Live Selfie -->
<script>
  let cameraStream = null;
  let capturedPhoto = null;

  // Get DOM elements
  const startCameraBtn = document.getElementById('startCameraBtn');
  const capturePhotoBtn = document.getElementById('capturePhotoBtn');
  const retakePhotoBtn = document.getElementById('retakePhotoBtn');
  const cameraPreview = document.getElementById('cameraPreview');
  const photoCanvas = document.getElementById('photoCanvas');
  const capturedImageDisplay = document.getElementById('capturedImageDisplay');
  const capturedImage = document.getElementById('capturedImage');
  const selfiePreview = document.getElementById('selfiePreview');

  // Start camera
  startCameraBtn?.addEventListener('click', async () => {
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({ 
        video: { 
          width: 300, 
          height: 225,
          facingMode: 'user'
        } 
      });
      
      cameraPreview.srcObject = cameraStream;
      cameraPreview.style.display = 'block';
      capturedImageDisplay.style.display = 'none';
      
      startCameraBtn.style.display = 'none';
      capturePhotoBtn.style.display = 'inline-block';
      retakePhotoBtn.style.display = 'none';
      
      // Clear any previous preview
      selfiePreview.innerHTML = '';
      
    } catch (error) {
      console.error('Error accessing camera:', error);
      alert('Unable to access camera. Please ensure you have granted camera permissions. Camera access is required for identity verification.');
    }
  });

  // Capture photo
  capturePhotoBtn?.addEventListener('click', () => {
    try {
      const context = photoCanvas.getContext('2d');
      
      // Draw video frame to canvas
      context.drawImage(cameraPreview, 0, 0, 300, 225);
      
      // Get image as data URL
      const imageDataURL = photoCanvas.toDataURL('image/jpeg', 0.9);
      
      // Show captured image
      capturedImage.src = imageDataURL;
      capturedImageDisplay.style.display = 'block';
      
      // Hide camera preview
      cameraPreview.style.display = 'none';
      
      // Update buttons
      capturePhotoBtn.style.display = 'none';
      retakePhotoBtn.style.display = 'inline-block';
      
      // Show success message in preview area
      selfiePreview.innerHTML = `
        <div class="captured-photo-container">
          <div class="success-message">
            <h6>‚úì Selfie Captured Successfully</h6>
            <p>Your live selfie has been captured and is ready for verification</p>
          </div>
          <div class="photo-info">
            <small>Photo captured: ${new Date().toLocaleString()}</small>
          </div>
        </div>
      `;
      
      // Convert to blob for upload
      photoCanvas.toBlob((blob) => {
        capturedPhoto = blob;
        console.log('Photo captured successfully, blob size:', blob.size);
      }, 'image/jpeg', 0.9);
      
      // Stop camera stream
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      
    } catch (error) {
      console.error('Error capturing photo:', error);
      alert('Error capturing photo. Please try again.');
    }
  });

  // Retake photo
  retakePhotoBtn?.addEventListener('click', () => {
    // Clear displays
    capturedImageDisplay.style.display = 'none';
    selfiePreview.innerHTML = '';
    capturedPhoto = null;
    
    // Reset buttons
    retakePhotoBtn.style.display = 'none';
    startCameraBtn.style.display = 'inline-block';
  });

  // Function to get selfie data for upload
  function getSelfieData() {
    return capturedPhoto;
  }
</script>

<style>
/* Enhanced Verification Styles */
body {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.verification-section {
  padding: 32px 0;
  background: #f8fafc;
  flex: 1;
}

.verification-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 32px;
  padding: 24px;
  background: linear-gradient(135deg, #1e90ff, #0066cc, #004499, #002266);
  border-radius: 20px;
  color: white;
  box-shadow: 0 8px 32px rgba(30, 144, 255, 0.3);
}

.header-content h1 {
  margin: 0 0 8px 0;
  font-size: 2rem;
  font-weight: 700;
}

.header-subtitle {
  margin: 0;
  opacity: 0.9;
  font-size: 1.1rem;
}

.verification-progress {
  display: flex;
  align-items: center;
  gap: 16px;
}

.progress-circle {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
}

.progress-text {
  font-size: 1.2rem;
  font-weight: 700;
}

.progress-info {
  text-align: left;
}

.progress-label {
  font-size: 0.9rem;
  opacity: 0.8;
}

.progress-steps {
  font-size: 1rem;
  font-weight: 600;
}

.verification-grid {
  display: grid;
  grid-template-columns: 350px 1fr;
  gap: 24px;
}

.status-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 12px rgba(16, 24, 40, 0.08);
  height: fit-content;
  position: sticky;
  top: 24px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid #e5e7eb;
}

.card-header h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.verification-level {
  background: #f3f4f6;
  color: #374151;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
}

.status-summary {
  margin-bottom: 24px;
}

.status-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid #f3f4f6;
}

.status-item:last-child {
  border-bottom: none;
}

.status-icon {
  font-size: 1.5rem;
}

.status-content {
  flex: 1;
}

.status-title {
  font-weight: 600;
  margin-bottom: 2px;
}

.status-desc {
  font-size: 0.875rem;
  color: #6b7280;
}

.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.status-badge.pending {
  background: #fef3c7;
  color: #d97706;
}

.status-badge.verified {
  background: #d1fae5;
  color: #059669;
}

.verification-benefits {
  background: #f8fafc;
  padding: 16px;
  border-radius: 12px;
}

.verification-benefits h4 {
  margin: 0 0 12px 0;
  font-size: 1rem;
  font-weight: 600;
}

.verification-benefits ul {
  margin: 0;
  padding: 0;
  list-style: none;
}

.verification-benefits li {
  padding: 4px 0;
  font-size: 0.875rem;
  color: #374151;
}

.steps-card {
  background: white;
  border-radius: 16px;
  padding: 32px;
  box-shadow: 0 4px 12px rgba(16, 24, 40, 0.08);
}

.verification-step {
  margin-bottom: 32px;
  padding: 24px;
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  transition: all 0.3s ease;
}

.verification-step:hover {
  border-color: #d1d5db;
  box-shadow: 0 4px 12px rgba(16, 24, 40, 0.08);
}

.verification-step.completed {
  border-color: #10b981;
  background: #f0fdf4;
}

.step-header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 20px;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #e5e7eb;
  color: #6b7280;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1.1rem;
}

.verification-step.completed .step-number {
  background: #10b981;
  color: white;
}

.step-content {
  flex: 1;
}

.step-content h3 {
  margin: 0 0 4px 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.step-description {
  margin: 0;
  color: #6b7280;
  font-size: 0.95rem;
}

.step-status {
  margin-left: auto;
}

.step-body {
  margin-left: 56px;
}

.step-info {
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
  padding: 16px;
  background: #f8fafc;
  border-radius: 12px;
}

.info-icon {
  font-size: 1.5rem;
}

.info-content p {
  margin: 0 0 8px 0;
  color: #374151;
}

.email-address {
  font-weight: 600;
  color: #1f2937;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #374151;
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #3b82f6;
}

.form-row {
  display: flex;
  gap: 16px;
}

.form-row.two .form-group {
  flex: 1;
}

.input-group {
  display: flex;
  gap: 8px;
}

.country-select {
  width: 120px;
  flex-shrink: 0;
}

.form-help {
  font-size: 0.875rem;
  color: #6b7280;
  margin-top: 4px;
}

.step-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-secondary {
  background: #f3f4f6;
  color: #374151;
}

.btn-secondary:hover {
  background: #e5e7eb;
}

.btn-icon {
  font-size: 1rem;
}

.step-help {
  padding: 12px 16px;
  background: #fef3c7;
  border-radius: 8px;
  border-left: 4px solid #f59e0b;
}

.step-help p {
  margin: 0;
  font-size: 0.875rem;
  color: #92400e;
}

.document-upload-section {
  margin: 24px 0;
}

.document-upload-section h4 {
  margin: 0 0 16px 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #374151;
}

.upload-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 16px;
}

.upload-item {
  position: relative;
}

.upload-area {
  border: 2px dashed #d1d5db;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
}

.upload-area:hover {
  border-color: #3b82f6;
  background: #f8fafc;
}

.upload-icon {
  font-size: 2rem;
  margin-bottom: 12px;
}

.upload-text h5 {
  margin: 0 0 4px 0;
  font-size: 1rem;
  font-weight: 600;
}

.upload-text p {
  margin: 0 0 16px 0;
  color: #6b7280;
  font-size: 0.875rem;
}

.upload-btn {
  background: #3b82f6;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
}

.file-preview {
  margin-top: 12px;
  display: none;
}

.file-preview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.upload-requirements {
  background: #f0f9ff;
  padding: 16px;
  border-radius: 8px;
  margin: 16px 0;
}

.upload-requirements h5 {
  margin: 0 0 12px 0;
  font-size: 1rem;
  font-weight: 600;
  color: #1e40af;
}

.upload-requirements ul {
  margin: 0;
  padding: 0;
  list-style: none;
}

.upload-requirements li {
  padding: 4px 0;
  font-size: 0.875rem;
  color: #1e40af;
}

.location-section {
  background: #f8fafc;
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
}

.location-header h4 {
  margin: 0 0 8px 0;
  font-size: 1rem;
  font-weight: 600;
}

.location-header p {
  margin: 0 0 16px 0;
  color: #6b7280;
  font-size: 0.875rem;
}

.location-input {
  display: flex;
  gap: 12px;
  align-items: center;
}

.location-input input {
  flex: 1;
}

.otp-section {
  background: #f0fdf4;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #bbf7d0;
}

.otp-input-group {
  display: flex;
  gap: 12px;
  align-items: center;
}

.otp-input-group input {
  flex: 1;
  text-align: center;
  font-size: 1.2rem;
  letter-spacing: 2px;
}

.phone-form {
  background: #f8fafc;
  padding: 20px;
  border-radius: 12px;
  margin: 16px 0;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.shop-form {
  background: #f8fafc;
  padding: 20px;
  border-radius: 12px;
  margin: 16px 0;
}

.shop-form h4 {
  margin: 0 0 16px 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #374151;
}

/* Clean Status Layout */
.status-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 0;
  border-bottom: 1px solid #f3f4f6;
}

.status-item:last-child {
  border-bottom: none;
}

.status-content {
  flex: 1;
}

.step-info {
  background: #f8fafc;
  padding: 20px;
  border-radius: 12px;
  margin: 16px 0;
}

.info-content {
  width: 100%;
}

/* Professional Phone Input Styling */
.phone-input-group {
  display: flex;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  overflow: hidden;
  background: white;
  transition: border-color 0.2s ease;
}

.phone-input-group:focus-within {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.country-code {
  background: #f8fafc;
  border-right: 1px solid #d1d5db;
  padding: 12px 16px;
  font-weight: 600;
  color: #374151;
  display: flex;
  align-items: center;
  min-width: 60px;
  justify-content: center;
}

.phone-input {
  flex: 1;
  border: none;
  padding: 12px 16px;
  font-size: 16px;
  outline: none;
  background: transparent;
}

.phone-input::placeholder {
  color: #9ca3af;
}

.otp-input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 16px;
  text-align: center;
  letter-spacing: 2px;
  font-weight: 600;
  transition: border-color 0.2s ease;
}

.otp-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.otp-input::placeholder {
  color: #9ca3af;
  letter-spacing: normal;
  font-weight: normal;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
  font-size: 14px;
}

.form-help {
  display: block;
  margin-top: 6px;
  font-size: 12px;
  color: #6b7280;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  flex-wrap: wrap;
}

.btn {
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.btn.primary {
  background: #3b82f6;
  color: white;
}

.btn.primary:hover {
  background: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.btn.secondary {
  background: #f8fafc;
  color: #374151;
  border: 1px solid #d1d5db;
}

.btn.secondary:hover {
  background: #f1f5f9;
  border-color: #9ca3af;
}

/* Camera Section Styling */
.camera-section {
  text-align: center;
  margin: 20px 0;
}

.camera-controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 16px;
}

#cameraPreview {
  border: 2px solid #e5e7eb;
  background: #f9fafb;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.upload-area {
  text-align: center;
  padding: 24px;
  border: 2px dashed #d1d5db;
  border-radius: 12px;
  background: #f9fafb;
  transition: all 0.2s ease;
}

.upload-area:hover {
  border-color: #3b82f6;
  background: #f0f9ff;
}

.upload-text h5 {
  margin: 0 0 8px 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #374151;
}

.upload-text p {
  margin: 0;
  color: #6b7280;
  font-size: 0.9rem;
}

/* Captured Photo Preview Styling */
.captured-photo-container {
  text-align: center;
  padding: 20px;
  background: #f0fdf4;
  border: 2px solid #bbf7d0;
  border-radius: 12px;
  margin-top: 20px;
}

.success-message {
  margin-bottom: 16px;
}

.success-message h6 {
  margin: 0 0 8px 0;
  color: #15803d;
  font-size: 1.1rem;
  font-weight: 600;
}

.success-message p {
  margin: 0;
  color: #166534;
  font-size: 0.9rem;
}

.captured-selfie {
  max-width: 250px;
  width: 100%;
  height: auto;
  border-radius: 12px;
  border: 3px solid #22c55e;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
  margin: 16px 0;
}

.photo-info {
  margin-top: 12px;
}

  .photo-info small {
    color: #15803d;
    font-size: 0.8rem;
    font-weight: 500;
  }

  /* Business Location Verification Styling */
  .location-verification-section {
    margin: 20px 0;
    padding: 20px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: #f9fafb;
  }

  .location-verification-section h4 {
    margin: 0 0 8px 0;
    color: #374151;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .location-verification-section p {
    margin: 0 0 16px 0;
    color: #6b7280;
    font-size: 0.9rem;
  }

  .location-controls {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }

  .location-status {
    font-size: 0.9rem;
    font-weight: 500;
  }

  .location-display {
    background: #f0fdf4;
    border: 2px solid #bbf7d0;
    border-radius: 8px;
    padding: 16px;
    margin-top: 12px;
  }

  .location-info h6 {
    margin: 0 0 8px 0;
    color: #15803d;
    font-size: 1rem;
    font-weight: 600;
  }

  .location-info p {
    margin: 0 0 4px 0;
    color: #166534;
    font-size: 0.9rem;
    font-family: monospace;
  }

  .location-info small {
    color: #15803d;
    font-size: 0.8rem;
  }

/* Responsive Design */
@media (max-width: 1024px) {
  .verification-grid {
    grid-template-columns: 1fr;
  }
  
  .status-card {
    position: static;
  }
}

@media (max-width: 768px) {
  .verification-header {
    flex-direction: column;
    text-align: center;
    gap: 16px;
  }
  
  .verification-progress {
    flex-direction: column;
    text-align: center;
  }
  
  .step-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .step-body {
    margin-left: 0;
  }
  
  .form-row {
    flex-direction: column;
  }
  
  .upload-grid {
    grid-template-columns: 1fr;
  }
  
  .step-actions {
    flex-direction: column;
  }
}
</style>

</body>
</html>
