<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Order Status â€“ Safe Trade Hub</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Load authentication system -->
  <script src="js/auth-manager.js"></script>
  <script src="js/header-manager.js"></script>
  <style>
    .status-timeline {
      margin: 24px 0;
    }
    
    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
      position: relative;
    }
    
    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 19px;
      top: 40px;
      width: 2px;
      height: calc(100% + 8px);
      background: #e5e7eb;
    }
    
    .timeline-item.completed::after {
      background: #10b981;
    }
    
    .timeline-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f3f4f6;
      color: #6b7280;
      border: 2px solid #e5e7eb;
      position: relative;
      z-index: 1;
    }
    
    .timeline-item.completed .timeline-icon {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }
    
    .timeline-item.current .timeline-icon {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(59, 130, 246, 0); }
    }
    
    .timeline-content {
      flex: 1;
    }
    
    .timeline-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #1f2937;
    }
    
    .timeline-description {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .timeline-time {
      color: #9ca3af;
      font-size: 12px;
    }
    
    .escrow-info {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }
    
    .info-label {
      color: #6b7280;
      font-weight: 500;
    }
    
    .info-value {
      font-weight: 600;
      color: #1f2937;
    }
    
    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 24px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-success {
      background: #10b981;
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
    }
    
    .btn-warning {
      background: #f59e0b;
      color: white;
    }
    
    .btn-warning:hover {
      background: #d97706;
    }
    
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #4b5563;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .dispute-section {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }
    
    .dispute-section h4 {
      color: #991b1b;
      margin: 0 0 8px 0;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <a href="index.html" class="logo">SafeTradeHub</a>
    <nav class="header-actions">
      <a class="icon-btn" href="cart.html" aria-label="Cart" title="Cart" style="position:relative">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M6 6h15l-1.5 9h-12z"/><path d="M6 6L5 3H2"/>
          <circle cx="9" cy="20" r="1.75"/><circle cx="18" cy="20" r="1.75"/>
        </svg>
        <span class="cart-count" id="cartCount">0</span>
      </a>
    </nav>
  </div>
</header>

  <section class="section">
    <div class="container">
      <div class="page-header">
        <h1>Order Status</h1>
        <p class="page-description">Track your order and escrow transaction</p>
      </div>

      <div class="card-like">
        <div id="orderContent">
          <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading order details...</p>
          </div>
        </div>
      </div>
    </div>
  </section>

<footer class="site-footer"><div class="container"><p>All Rights Reserved By Safe Trade Hub</p></div></footer>

<script>
// API Configuration
const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:5000' : '';
const API_ENDPOINTS = {
  orders: `${API_BASE}/api/orders`,
  escrow: `${API_BASE}/api/escrow`,
  disputes: `${API_BASE}/api/disputes`
};

// Global state
let currentOrder = null;
let currentEscrow = null;
let currentUser = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  initializeOrderStatus();
});

async function initializeOrderStatus() {
  try {
    // Wait for AuthManager to be ready
    if (window.AuthManager) {
      await window.AuthManager.waitForInit();
    }
    
    // Check authentication using global AuthManager
    currentUser = getCurrentUser();
    if (!currentUser) {
      window.location.href = 'auth.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
      return;
    }

    // Get order ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');
    
    if (!orderId) {
      showError('Order ID not provided');
      return;
    }

    // Load order data
    await loadOrderData(orderId);
    
  } catch (error) {
    console.error('Failed to initialize order status:', error);
    showError('Failed to load order data');
  }
}

function getCurrentUser() {
  // Use global AuthManager
  return window.AuthManager ? window.AuthManager.getCurrentUser() : null;
}

async function loadOrderData(orderId) {
  try {
    const token = localStorage.getItem('authToken');
    
    // Load order
    const orderResponse = await fetch(`${API_ENDPOINTS.orders}/${orderId}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (orderResponse.ok) {
      const orderData = await orderResponse.json();
      if (orderData.success) {
        currentOrder = orderData.data;
        
        // Load escrow data if available
        if (currentOrder.escrowId) {
          await loadEscrowData(currentOrder.escrowId);
        }
        
        renderOrderStatus();
      } else {
        throw new Error(orderData.message || 'Failed to load order');
      }
    } else {
      throw new Error('Order not found');
    }
    
  } catch (error) {
    console.error('Error loading order:', error);
    // Fallback to localStorage
    loadOrderFromLocalStorage(orderId);
  }
}

async function loadEscrowData(escrowId) {
  try {
    const token = localStorage.getItem('authToken');
    
    const escrowResponse = await fetch(`${API_ENDPOINTS.escrow}/${escrowId}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (escrowResponse.ok) {
      const escrowData = await escrowResponse.json();
      if (escrowData.success) {
        currentEscrow = escrowData.data.escrow;
      }
    }
  } catch (error) {
    console.error('Error loading escrow:', error);
  }
}

function loadOrderFromLocalStorage(orderId) {
  try {
    const orders = JSON.parse(localStorage.getItem('sthub_orders') || '[]');
    const escrows = JSON.parse(localStorage.getItem('sthub_escrows') || '[]');
    
    currentOrder = orders.find(o => o.id === orderId);
    currentEscrow = escrows.find(e => e.orderId === orderId);
    
    if (currentOrder) {
      renderOrderStatus();
    } else {
      showError('Order not found');
    }
  } catch (error) {
    console.error('Error loading from localStorage:', error);
    showError('Failed to load order data');
  }
}

function renderOrderStatus() {
  const container = document.getElementById('orderContent');
  if (!container) return;
  
  const timeline = getOrderTimeline();
  const canConfirmDelivery = currentOrder.status === 'awaiting_buyer_confirm';
  const canOpenDispute = ['confirmed', 'shipped_to_escrow', 'at_escrow', 'awaiting_buyer_confirm'].includes(currentOrder.status);
  
  container.innerHTML = `
    <div class="escrow-info">
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Order ID</span>
          <span class="info-value">${currentOrder.id}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Escrow ID</span>
          <span class="info-value">${currentEscrow?.id || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Total Amount</span>
          <span class="info-value">${formatCurrency(currentOrder.total)}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Escrow Location</span>
          <span class="info-value">${currentOrder.escrowLocation || 'N/A'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Payment Method</span>
          <span class="info-value">Wallet Tokens</span>
        </div>
        <div class="info-item">
          <span class="info-label">Current Status</span>
          <span class="info-value">${getStatusLabel(currentOrder.status)}</span>
        </div>
      </div>
    </div>
    
    <div class="status-timeline">
      ${timeline.map(item => `
        <div class="timeline-item ${item.status}">
          <div class="timeline-icon">
            <i class="${item.icon}"></i>
          </div>
          <div class="timeline-content">
            <div class="timeline-title">${item.title}</div>
            <div class="timeline-description">${item.description}</div>
            ${item.time ? `<div class="timeline-time">${item.time}</div>` : ''}
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="action-buttons">
      ${canConfirmDelivery ? `
        <button class="btn btn-success" onclick="confirmDelivery()">
          <i class="fas fa-check"></i>
          Confirm Delivery & Release Funds
        </button>
      ` : ''}
      
      ${canOpenDispute ? `
        <button class="btn btn-warning" onclick="openDispute()">
          <i class="fas fa-exclamation-triangle"></i>
          Open Dispute
        </button>
      ` : ''}
      
      <button class="btn btn-secondary" onclick="refreshOrderStatus()">
        <i class="fas fa-sync-alt"></i>
        Refresh Status
      </button>
      
      <a href="wallet.html" class="btn btn-primary">
        <i class="fas fa-wallet"></i>
        View Wallet
      </a>
      
      <a href="dashboard.html" class="btn btn-secondary">
        <i class="fas fa-home"></i>
        Back to Dashboard
      </a>
    </div>
    
    ${currentOrder.status === 'disputed' ? `
      <div class="dispute-section">
        <h4><i class="fas fa-gavel"></i> Dispute Opened</h4>
        <p>A dispute has been opened for this order. Our admin team will review the case and take appropriate action.</p>
      </div>
    ` : ''}
  `;
}

function getOrderTimeline() {
  const stages = [
    {
      key: 'pending',
      title: 'Order Placed',
      description: 'Order created and awaiting payment confirmation',
      icon: 'fas fa-shopping-cart'
    },
    {
      key: 'confirmed',
      title: 'Payment Confirmed',
      description: 'Tokens held in escrow - seller notified to ship',
      icon: 'fas fa-credit-card'
    },
    {
      key: 'shipped_to_escrow',
      title: 'Shipped to Escrow Location',
      description: 'Seller has shipped the product to the escrow location',
      icon: 'fas fa-truck'
    },
    {
      key: 'at_escrow',
      title: 'At Escrow Location',
      description: 'Product arrived and is being verified at escrow location',
      icon: 'fas fa-building'
    },
    {
      key: 'awaiting_buyer_confirm',
      title: 'Awaiting Buyer Confirmation',
      description: 'Product verified - awaiting buyer delivery confirmation',
      icon: 'fas fa-clock'
    },
    {
      key: 'completed',
      title: 'Order Completed',
      description: 'Delivery confirmed - funds released to seller',
      icon: 'fas fa-check-circle'
    }
  ];
  
  const currentIndex = stages.findIndex(s => s.key === currentOrder.status);
  
  return stages.map((stage, index) => {
    let status = 'pending';
    if (index < currentIndex) status = 'completed';
    else if (index === currentIndex) status = 'current';
    
    // Handle special cases
    if (currentOrder.status === 'disputed' && index >= currentIndex) {
      status = 'disputed';
    }
    if (currentOrder.status === 'refunded' && index === stages.length - 1) {
      stage.title = 'Order Refunded';
      stage.description = 'Order refunded - tokens returned to buyer';
      stage.icon = 'fas fa-undo';
      status = 'completed';
    }
    
    return {
      ...stage,
      status,
      time: getStageTime(stage.key)
    };
  });
}

function getStageTime(stageKey) {
  // In a real app, this would come from the order timeline
  if (currentEscrow?.timeline) {
    const timelineEntry = currentEscrow.timeline.find(t => t.status === stageKey);
    if (timelineEntry?.timestamp) {
      return formatDate(timelineEntry.timestamp);
    }
  }
  
  if (stageKey === 'pending' && currentOrder.createdAt) {
    return formatDate(currentOrder.createdAt);
  }
  
  return null;
}

function getStatusLabel(status) {
  const labels = {
    'pending': 'Order Pending',
    'confirmed': 'Payment Confirmed',
    'shipped_to_escrow': 'Shipped to Escrow',
    'at_escrow': 'At Escrow Location',
    'awaiting_buyer_confirm': 'Awaiting Confirmation',
    'completed': 'Completed',
    'refunded': 'Refunded',
    'disputed': 'Disputed',
    'cancelled': 'Cancelled'
  };
  return labels[status] || status;
}

async function confirmDelivery() {
  if (!currentEscrow?.id) {
    alert('Escrow information not available');
    return;
  }
  
  const confirmed = confirm(
    'Are you sure you want to confirm delivery? This will release the funds to the seller and cannot be undone.'
  );
  
  if (!confirmed) return;
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(`${API_ENDPOINTS.escrow}/${currentEscrow.id}/confirm-delivery`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        rating: null, // Could add rating UI later
        review: null
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.success) {
        alert('Delivery confirmed! Funds have been released to the seller.');
        await loadOrderData(currentOrder.id);
      } else {
        throw new Error(data.message || 'Failed to confirm delivery');
      }
    } else {
      throw new Error('Failed to confirm delivery');
    }
  } catch (error) {
    console.error('Error confirming delivery:', error);
    alert('Failed to confirm delivery. Please try again.');
  }
}

async function openDispute() {
  const reason = prompt('Please provide a reason for the dispute:');
  if (!reason || !reason.trim()) {
    return;
  }
  
  try {
    const token = localStorage.getItem('authToken');
    
    const response = await fetch(API_ENDPOINTS.disputes, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        orderId: currentOrder.id,
        escrowId: currentEscrow?.id,
        reason: reason.trim(),
        type: 'product_issue'
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.success) {
        alert('Dispute opened successfully. Our admin team will review your case.');
        await loadOrderData(currentOrder.id);
      } else {
        throw new Error(data.message || 'Failed to open dispute');
      }
    } else {
      throw new Error('Failed to open dispute');
    }
  } catch (error) {
    console.error('Error opening dispute:', error);
    alert('Failed to open dispute. Please try again.');
  }
}

async function refreshOrderStatus() {
  if (currentOrder?.id) {
    await loadOrderData(currentOrder.id);
  }
}

function showError(message) {
  const container = document.getElementById('orderContent');
  if (container) {
    container.innerHTML = `
      <div class="error">
        <i class="fas fa-exclamation-triangle"></i>
        <strong>Error:</strong> ${message}
      </div>
      <div class="action-buttons">
        <a href="dashboard.html" class="btn btn-primary">
          <i class="fas fa-home"></i>
          Back to Dashboard
        </a>
      </div>
    `;
  }
}

function formatCurrency(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD'
  }).format(amount);
}

function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    return new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }).format(date);
  } catch (error) {
    return 'Invalid date';
  }
}
</script>
</body>
</html>
