<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management - SafeTradeHub</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Styles -->
  <link rel="stylesheet" href="/static/css/dashboard.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="/static/js/firebase-config.js"></script>
</head>

<body>

  <!-- Sidebar -->
  <aside class="dashboard-sidebar">
    <div class="sidebar-header">
      <a href="index.html" class="sidebar-logo">
        <i class="fas fa-shield-alt"></i> SafeTradeHub
      </a>
    </div>

    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">
        <i class="fas fa-home"></i> Dashboard
      </a>
      <a href="orders.html" class="nav-item">
        <i class="fas fa-box"></i> Orders
      </a>
      <a href="product-management.html" class="nav-item active">
        <i class="fas fa-tags"></i> Products
      </a>
      <a href="verification.html" class="nav-item">
        <i class="fas fa-check-circle"></i> Verification
      </a>
      <a href="wallet.html" class="nav-item">
        <i class="fas fa-wallet"></i> Wallet
      </a>
      <a href="messages.html" class="nav-item">
        <i class="fas fa-envelope"></i> Messages
      </a>
      <a href="profile.html" class="nav-item">
        <i class="fas fa-user"></i> Profile
      </a>
      <a href="settings.html" class="nav-item">
        <i class="fas fa-cog"></i> Settings
      </a>
    </nav>

    <div class="sidebar-footer">
      <div class="user-mini-profile">
        <img src="/static/images/avatar-placeholder.png" alt="User" class="user-avatar-small" id="userAvatar">
        <div class="user-info-mini">
          <h4 id="userName">Loading...</h4>
          <span id="userRole">...</span>
        </div>
      </div>
      <a href="#" onclick="logout()" class="nav-item" style="color: var(--danger);">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </aside>

  <script>
    // Immediate check to prevent flicker
    (function () {
      const userData = localStorage.getItem('userData');
      if (userData) {
        try {
          const user = JSON.parse(userData);
          if (user.role === 'Seller') {
            const navProducts = document.getElementById('navProducts');
            if (navProducts) navProducts.style.display = 'flex';
          }
        } catch (e) {
          console.error('Error parsing user data for sidebar:', e);
        }
      }
    })();
  </script>

  <!-- Main Content -->
  <main class="dashboard-main">
    <div class="dashboard-topbar">
      <div class="page-title">
        <h1>Product Management</h1>
        <p>Manage your listings and inventory</p>
      </div>
      <a href="product-upload.html" class="action-btn"
        style="padding: 0.75rem 1.5rem; flex-direction: row; gap: 0.5rem; background: var(--primary-color); color: white; border: none;">
        <i class="fas fa-plus" style="color: white; font-size: 1rem; margin: 0;"></i>
        <span>Add New Product</span>
      </a>
    </div>

    <div id="productsContent">
      <div class="dashboard-card">
        <div class="card-header">
          <h3>Your Products</h3>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="dashboard-table" id="productsTable">
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Price</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Views</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="7" style="text-align:center;">Loading products...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- View Product Modal -->
  <div id="viewProductModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content"
      style="background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative;">
      <span class="close" onclick="closeModal()"
        style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      <h2 style="margin-top: 0; color: var(--primary-color);">Product Details</h2>
      <div id="modalBody" style="margin-top: 20px;">
        <p>Loading...</p>
      </div>
    </div>
  </div>

  <script>
    // Product Management Logic
    document.addEventListener('DOMContentLoaded', async () => {
      const auth = firebase.auth();
      const db = firebase.database();

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          window.location.href = 'auth.html?mode=signin';
          return;
        }

        // Load User Data
        const userSnap = await db.ref('users/' + user.uid).once('value');
        const userData = userSnap.val();

        updateUserProfile(userData);

        if (userData.role !== 'Seller') {
          alert('Access denied. Seller account required.');
          window.location.href = 'dashboard.html';
          return;
        }

        loadProducts(user.uid);
      });
    });

    function updateUserProfile(user) {
      document.getElementById('userName').textContent = user.displayName || user.fullName || 'User';
      document.getElementById('userRole').textContent = user.role || 'Buyer';
      const avatar = document.getElementById('userAvatar');
      if (user.profilePic || user.profile?.avatar) {
        avatar.src = user.profilePic || user.profile?.avatar;
      } else {
        avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=random`;
      }
    }

    async function loadProducts(uid) {
      const db = firebase.database();
      const tbody = document.querySelector('#productsTable tbody');

      try {
        // Fetch all products and filter client-side to ensure accuracy
        const snap = await db.ref('products').once('value');
        const products = [];

        snap.forEach(child => {
          const p = child.val();
          if (p.sellerId === uid) {
            products.push({ id: child.key, ...p });
          }
        });

        if (products.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No products found</td></tr>';
          return;
        }

        tbody.innerHTML = products.map(p => {
          // Handle image
          let imgUrl = 'images/placeholder.jpg';
          if (Array.isArray(p.images) && p.images.length > 0) {
            imgUrl = p.images.find(img => img.isMain)?.url || p.images[0].url;
          } else if (typeof p.images === 'string') {
            imgUrl = p.images;
          } else if (p.img) {
            imgUrl = p.img;
          }

          return `
                        <tr>
                            <td><img src="${imgUrl}" alt="${p.name}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;"></td>
                            <td>${p.name || p.title}</td>
                            <td>RS ${p.price}</td>
                            <td>${p.category || 'N/A'}</td>
                            <td><span class="status-badge ${p.isActive !== false ? 'completed' : 'pending'}">${p.isActive !== false ? 'Active' : 'Inactive'}</span></td>
                            <td>${p.views || 0}</td>
                            <td>
                                <div class="action-buttons-container">
                                    <button onclick="viewProduct('${p.id}')" class="btn-icon view" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="product-edit.html?id=${p.id}" class="btn-icon edit" title="Edit">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    <button onclick="deleteProduct('${p.id}')" class="btn-icon delete" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
        }).join('');

      } catch (error) {
        console.error('Error loading products:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:red;">Error loading products</td></tr>';
      }
    }

    async function viewProduct(id) {
      const modal = document.getElementById('viewProductModal');
      const modalBody = document.getElementById('modalBody');
      modal.style.display = "block";
      modalBody.innerHTML = '<p>Loading details...</p>';

      try {
        const snapshot = await firebase.database().ref('products/' + id).once('value');
        const p = snapshot.val();

        if (!p) {
          modalBody.innerHTML = '<p>Product not found.</p>';
          return;
        }

        // Handle images
        let imagesHtml = '';
        if (Array.isArray(p.images) && p.images.length > 0) {
          imagesHtml = p.images.map(img => `<img src="${img.url}" style="width: 100px; height: 100px; object-fit: cover; margin-right: 10px; border-radius: 4px;">`).join('');
        } else if (typeof p.images === 'string') {
          imagesHtml = `<img src="${p.images}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;">`;
        } else if (p.img) {
          imagesHtml = `<img src="${p.img}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;">`;
        }

        modalBody.innerHTML = `
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            ${imagesHtml}
                        </div>
                        <div style="flex: 2; min-width: 300px;">
                            <h3 style="margin-top: 0;">${p.name || p.title}</h3>
                            <p><strong>Price:</strong> RS ${p.price}</p>
                            <p><strong>Category:</strong> ${p.category || 'N/A'}</p>
                            <p><strong>Status:</strong> <span class="status-badge ${p.isActive !== false ? 'completed' : 'pending'}">${p.isActive !== false ? 'Active' : 'Inactive'}</span></p>
                            <p><strong>Views:</strong> ${p.views || 0}</p>
                            <p><strong>Description:</strong></p>
                            <p style="background: #f9f9f9; padding: 10px; border-radius: 4px;">${p.description || 'No description available.'}</p>
                        </div>
                    </div>
                `;
      } catch (error) {
        console.error('Error fetching product details:', error);
        modalBody.innerHTML = '<p style="color: red;">Error loading details.</p>';
      }
    }

    function closeModal() {
      document.getElementById('viewProductModal').style.display = "none";
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
      const modal = document.getElementById('viewProductModal');
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        await firebase.database().ref('products/' + id).remove();
        // Also remove from user's products list if you maintain one, but here we just reload
        location.reload();
      } catch (error) {
        alert('Error deleting product: ' + error.message);
      }
    }

    function logout() {
      firebase.auth().signOut().then(() => window.location.href = 'index.html');
    }
  </script>
</body>

</html>
