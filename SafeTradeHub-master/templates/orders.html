<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders - SafeTradeHub</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <link rel="stylesheet" href="/static/css/dashboard.css">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="/static/js/firebase-config.js"></script>
</head>

<body>

    <!-- Sidebar -->
    <aside class="dashboard-sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="sidebar-logo">
                <i class="fas fa-shield-alt"></i> SafeTradeHub
            </a>
        </div>

        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="orders.html" class="nav-item active">
                <i class="fas fa-box"></i> Orders
            </a>
            <a href="product-management.html" class="nav-item" id="navProducts" style="display: none;">
                <i class="fas fa-tags"></i> Products
            </a>
            <a href="verification.html" class="nav-item">
                <i class="fas fa-check-circle"></i> Verification
            </a>
            <a href="wallet.html" class="nav-item">
                <i class="fas fa-wallet"></i> Wallet
            </a>
            <a href="messages.html" class="nav-item">
                <i class="fas fa-envelope"></i> Messages
            </a>
            <a href="profile.html" class="nav-item">
                <i class="fas fa-user"></i> Profile
            </a>
            <a href="settings.html" class="nav-item">
                <i class="fas fa-cog"></i> Settings
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-mini-profile">
                <img src="/static/images/avatar-placeholder.png" alt="User" class="user-avatar-small" id="userAvatar">
                <div class="user-info-mini">
                    <h4 id="userName">Loading...</h4>
                    <span id="userRole">...</span>
                </div>
            </div>
            <a href="#" onclick="logout()" class="nav-item" style="color: var(--danger);">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </aside>

    <script>
        // Immediate check to prevent flicker
        (function () {
            const userData = localStorage.getItem('userData');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.role === 'Seller') {
                        const navProducts = document.getElementById('navProducts');
                        if (navProducts) navProducts.style.display = 'flex';
                    }
                } catch (e) {
                    console.error('Error parsing user data for sidebar:', e);
                }
            }
        })();
    </script>

    <!-- Main Content -->
    <main class="dashboard-main">
        <div class="dashboard-topbar">
            <div class="page-title">
                <h1>Orders</h1>
                <p>Manage and track your orders</p>
            </div>
        </div>

        <div id="ordersContent">
            <div class="dashboard-card">
                <div class="card-header">
                    <h3>All Orders</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="dashboard-table" id="ordersTable">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Seller</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align:center;">Loading orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Details Modal -->
        <div id="orderDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Order Details</h2>
                    <span class="close-modal" onclick="closeOrderModal()">&times;</span>
                </div>
                <div class="modal-body" id="orderModalBody">
                    <!-- Details injected here -->
                </div>
            </div>
        </div>

        <style>
            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                /* Center the modal content */
                display: none;
                /* Controlled by JS */
                align-items: center;
                justify-content: center;
            }

            /* When JS sets display: block, we want to override or handle centering. 
               Actually, easiest is to use a specific class or stick to margin centering if JS uses 'block'. 
               Let's stick to the existing 'block' behavior but optimize margins. */

            .modal-content {
                background-color: #fff;
                margin: 2vh auto;
                /* Very small top margin to maximize space */
                padding: 0;
                border: 0;
                width: 95%;
                /* Wider */
                max-width: 700px;
                border-radius: 12px;
                position: relative;
                max-height: 96vh;
                /* Almost full screen height */
                box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
                display: flex;
                flex-direction: column;
            }

            .modal-header {
                padding: 15px 20px;
                border-bottom: 1px solid #eee;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-shrink: 0;
            }

            .modal-header h2 {
                margin: 0;
                font-size: 1.5rem;
            }

            .modal-body {
                padding: 20px;
                overflow-y: auto;
                /* Scroll ONLY the body */
                flex-grow: 1;
            }

            .close-modal {
                font-size: 28px;
                font-weight: bold;
                color: #aaa;
                cursor: pointer;
                line-height: 1;
            }

            .close-modal:hover {
                color: #000;
            }

            .order-section {
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid #eee;
            }

            .order-section h3 {
                margin-bottom: 10px;
                font-size: 1.1rem;
                color: #333;
            }

            .item-row {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .item-img {
                width: 50px;
                height: 50px;
                object-fit: cover;
                border-radius: 4px;
            }

            .action-btn-group {
                display: flex;
                gap: 8px;
            }

            .btn-action {
                padding: 4px 8px;
                font-size: 0.85rem;
                border-radius: 4px;
                text-decoration: none;
                color: white;
                background-color: #3b82f6;
                border: none;
                cursor: pointer;
            }

            .btn-action.secondary {
                background-color: #6b7280;
            }

            .participant-link {
                color: #3b82f6;
                text-decoration: none;
                font-weight: 500;
            }

            .participant-link:hover {
                text-decoration: underline;
            }
        </style>
    </main>

    <script>
        // Orders Page Logic
        document.addEventListener('DOMContentLoaded', async () => {
            const auth = firebase.auth();
            const db = firebase.database();

            auth.onAuthStateChanged(async (user) => {
                if (!user) {
                    window.location.href = 'auth.html?mode=signin';
                    return;
                }

                // Load User Data
                const userSnap = await db.ref('users/' + user.uid).once('value');
                const userData = userSnap.val();

                updateUserProfile(userData);

                // Show Products link if Seller
                if (userData.role === 'Seller') {
                    const navProducts = document.getElementById('navProducts');
                    if (navProducts) navProducts.style.display = 'flex';
                }

                loadOrders(user.uid, userData.role);
            });
        });

        function updateUserProfile(user) {
            document.getElementById('userName').textContent = user.displayName || user.fullName || 'User';
            document.getElementById('userRole').textContent = user.role || 'Buyer';
            const avatar = document.getElementById('userAvatar');
            if (user.profilePic || user.profile?.avatar) {
                avatar.src = user.profilePic || user.profile?.avatar;
            } else {
                avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || 'User')}&background=random`;
            }
        }

        async function loadOrders(uid, role) {
            const db = firebase.database();
            const tableHead = document.querySelector('#ordersTable thead tr');
            const tbody = document.querySelector('#ordersTable tbody');

            // Update Header based on Role
            if (role === 'Seller') {
                tableHead.innerHTML = `
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Buyer</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                `;
            } else {
                tableHead.innerHTML = `
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Seller</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                `;
            }

            try {
                let orders = [];

                if (role === 'Seller') {
                    // "Deep Filter" Logic:
                    // 1. Fetch recent orders
                    // 2. check if sellerId matches root OR items
                    // 3. IF NOT, check the product owner directly (db lookup) to handle historic data
                    const snap = await db.ref('orders').limitToLast(50).once('value');

                    if (snap.exists()) {
                        const checkOwnershipPromises = [];

                        snap.forEach(child => {
                            const o = child.val();
                            const checkPromise = async () => {
                                // 1. Direct Check
                                if (o.sellerId === uid) return { id: child.key, ...o };
                                if (o.items && Array.isArray(o.items) && o.items.some(i => i.sellerId === uid)) return { id: child.key, ...o };

                                // 2. Indirect Check (Product Lookup)
                                // Only do this if direct check failed and we have an item ID
                                if (o.items && o.items[0] && o.items[0].id) {
                                    try {
                                        const pSnap = await db.ref(`products/${o.items[0].id}/sellerId`).once('value');
                                        if (pSnap.exists() && pSnap.val() === uid) {
                                            return { id: child.key, ...o };
                                        }
                                    } catch (e) { /* ignore */ }
                                }
                                return null;
                            };
                            checkOwnershipPromises.push(checkPromise());
                        });

                        const results = await Promise.all(checkOwnershipPromises);
                        orders = results.filter(res => res !== null);
                    }
                } else {
                    // Fetch buyer orders - Robust Fetch
                    // Instead of strict query, we fetch all and filter to handle structure variations
                    const snap = await db.ref('orders').once('value');
                    if (snap.exists()) {
                        snap.forEach(child => {
                            const val = child.val();
                            // Check root buyerId OR nested buyer.id
                            if (val.buyerId === uid || (val.buyer && val.buyer.id === uid)) {
                                orders.push({ id: child.key, ...val });
                            }
                        });
                    }
                }

                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No orders found</td></tr>';
                    return;
                }

                // Sort by date desc
                orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Process orders to fetch names
                const rows = await Promise.all(orders.map(async (o) => {
                    // robustness for finding IDs if they are in items
                    const rootBuyerId = o.buyerId;
                    const rootSellerId = o.sellerId;
                    const itemBuyerId = o.items && o.items[0] ? o.items[0].buyerId : null; // rare but possible
                    const itemSellerId = o.items && o.items[0] ? o.items[0].sellerId : null;

                    const effectiveBuyerId = rootBuyerId || itemBuyerId;
                    const effectiveSellerId = rootSellerId || itemSellerId;

                    const otherId = role === 'Seller' ? effectiveBuyerId : effectiveSellerId;

                    let otherName = role === 'Seller' ? 'Unknown Buyer' : 'Unknown Seller';
                    let otherProfileLink = '#';

                    if (otherId) {
                        try {
                            const uSnap = await db.ref('users/' + otherId).once('value');
                            if (uSnap.exists()) {
                                const u = uSnap.val();
                                otherName = u.displayName || u.fullName || (role === 'Seller' ? 'Buyer' : 'Seller');
                                otherProfileLink = `seller-profile.html?id=${otherId}`;
                            } else if (role === 'Buyer' && o.items && o.items.length > 0) {
                                // Fallback: If user not found (e.g. 'admin' or bad ID), try fetching from product
                                // This handles orders made with stale cart data
                                try {
                                    const productId = o.items[0].id;
                                    const pSnap = await db.ref('products/' + productId + '/sellerId').once('value');
                                    if (pSnap.exists()) {
                                        const realSellerId = pSnap.val();
                                        const realSellerSnap = await db.ref('users/' + realSellerId).once('value');
                                        if (realSellerSnap.exists()) {
                                            const realSeller = realSellerSnap.val();
                                            otherName = realSeller.displayName || realSeller.fullName || 'Seller';
                                            otherProfileLink = `seller-profile.html?id=${realSellerId}`;
                                        }
                                    }
                                } catch (err) { console.error('Fallback fetch failed', err); }
                            }
                        } catch (e) { console.error(e); }
                    } else if (role === 'Buyer' && o.items && o.items.length > 0) {
                        // Double Fallback: If no otherId was found at all initially
                        try {
                            const productId = o.items[0].id;
                            const pSnap = await db.ref('products/' + productId + '/sellerId').once('value');
                            if (pSnap.exists()) {
                                const realSellerId = pSnap.val();
                                const realSellerSnap = await db.ref('users/' + realSellerId).once('value');
                                if (realSellerSnap.exists()) {
                                    const realSeller = realSellerSnap.val();
                                    otherName = realSeller.displayName || realSeller.fullName || 'Seller';
                                    otherProfileLink = `seller-profile.html?id=${realSellerId}`;
                                }
                            }
                        } catch (err) { console.error('Double Fallback fetch failed', err); }
                    }

                    // Actions
                    let actionsHtml = `<a href="orderstatus.html?orderId=${o.id}" class="btn-action">Track Order</a>`;

                    if (role === 'Seller') {
                        // Add View Details button for Seller
                        // We store the data in a data attribute or just pass ID to function
                        const orderDataSafe = encodeURIComponent(JSON.stringify(o));
                        actionsHtml += ` <button onclick="openOrderModal('${o.id}')" class="btn-action secondary">Order Details</button>`;
                    }

                    return `
                        <tr>
                            <td>#${(o.id || '').substring(1, 6)}</td>
                            <td>${new Date(o.createdAt).toLocaleDateString()}</td>
                            <td><a href="${otherProfileLink}" class="participant-link">${otherName}</a></td>
                            <td>RS ${(o.total || 0).toFixed(2)}</td>
                            <td><span class="status-badge ${o.status === 'completed' ? 'completed' : 'pending'}">${o.status || 'Pending'}</span></td>
                            <td><div class="action-btn-group">${actionsHtml}</div></td>
                        </tr>
                    `;
                }));

                tbody.innerHTML = rows.join('');

                // Store orders globally for modal access if needed, or re-fetch active one
                window.currentOrders = {};
                orders.forEach(o => window.currentOrders[o.id] = o);

            } catch (error) {
                console.error('Error loading orders:', error);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">
                    Error loading orders: ${error.message || error.code || error} <br>
                    <small>Please ensure database rules are deployed to allow seller access.</small>
                </td></tr>`;
            }
        }

        function openOrderModal(orderId) {
            const order = window.currentOrders[orderId];
            if (!order) return;

            const modal = document.getElementById('orderDetailsModal');
            const body = document.getElementById('orderModalBody');

            // Handle different data structures (shippingAddress vs buyer object)
            const shipping = order.shippingAddress || order.buyer || {};
            const items = order.items || [];

            // Map fields carefully
            const name = shipping.fullName || shipping.name || 'N/A';
            const phone = shipping.phone || 'N/A';
            const address = shipping.address || shipping.street || '';
            const city = shipping.city ? `, ${shipping.city}` : '';
            const fullAddress = address + city;

            body.innerHTML = `
                <div class="order-section">
                    <h3>Status: <span class="status-badge ${order.status}">${order.status}</span></h3>
                    <p><strong>Order ID:</strong> ${order.id}</p>
                    <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleString()}</p>
                </div>

                <div class="order-section">
                    <h3>Shipping Details</h3>
                    <p><strong>Name:</strong> ${name}</p>
                    <p><strong>Phone:</strong> ${phone}</p>
                    <p><strong>Address:</strong> ${fullAddress || 'N/A'}</p>
                </div>

                <div class="order-section">
                    <h3>Ordered Items</h3>
                    ${items.map(item => `
                        <div class="item-row">
                            <img src="${item.img || item.image || '/static/images/placeholder.jpg'}" class="item-img" alt="${item.name}">
                            <div>
                                <p><strong>${item.name || item.title}</strong></p>
                                <p>Qty: ${(item.quantity || item.qty || 1)} x RS ${(item.price || 0)}</p>
                            </div>
                        </div>
                    `).join('')}
                    <hr>
                    <p style="text-align:right; font-weight:bold; font-size:1.1rem;">Total: RS ${(order.total || 0).toFixed(2)}</p>
                </div>
            `;

            modal.style.display = 'block';
        }

        function closeOrderModal() {
            document.getElementById('orderDetailsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('orderDetailsModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function logout() {
            firebase.auth().signOut().then(() => window.location.href = 'index.html');
        }
    </script>
</body>

</html>