?<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Safe Trade Hub – Cart</title>
  <link rel="stylesheet" href="/static/css/style.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Firebase Configuration -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0RraIZr7Z3rjKIYw6dE2g_9Waqll5JvI",
      authDomain: "safetradehub-def1d.firebaseapp.com",
      databaseURL: "https://safetradehub-def1d-default-rtdb.firebaseio.com",
      projectId: "safetradehub-def1d",
      storageBucket: "safetradehub-def1d.firebasestorage.app",
      messagingSenderId: "633146502278",
      appId: "1:633146502278:web:6c82d4a0768daebdd7b507",
      measurementId: "G-1857Q7JPKZ"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>

  <!-- Load authentication system -->
  <script src="/static/js/auth-manager.js"></script>
  <script src="/static/js/header-manager.js"></script>
</head>

<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo" aria-label="Safe Trade Hub Home">SafeTradeHub</a>

      <nav class="header-actions" aria-label="Top actions">
        <!-- Navigation will be updated by HeaderManager -->
      </nav>
    </div>
  </header>

  <!-- Cart -->
  <section class="section cart-wrap">
    <div class="container">
      <h1 style="margin:0 0 16px">Your Cart</h1>

      <div class="cart-grid">
        <!-- Items -->
        <div class="cart-card">
          <div id="cartItems"></div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
            <button class="btn clear-btn" id="clearCartBtn">Clear Cart</button>
          </div>
        </div>

        <!-- Summary -->
        <aside class="cart-card summary" aria-label="Order summary">
          <h3 style="margin:0 0 8px">Summary</h3>
          <div class="total-line"><span>Subtotal</span><strong id="subtotal">—</strong></div>
          <div class="total-line"><span>Shipping</span><span id="shippingTotal">Free</span></div>
          <hr style="border:none;border-top:1px solid #eef1f6; margin:8px 0">
          <div class="total-line" style="font-size:1.1rem"><span>Total</span><strong id="grandTotal">—</strong></div>
          <button class="btn primary" id="processOrderBtn">Proceed to Checkout</button>
          <p class="muted-note" style="color:var(--muted); font-size:.9rem; margin-top:8px">
            * MVP: creates a local order and clears the cart.
          </p>
        </aside>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <p>All Rights Reserved By Safe Trade Hub</p>
    </div>
  </footer>

  <!-- Chat container -->
  <div id="chatbot-container" class="chatbot-container">
    <iframe src="https://safetradehub-d797d24354d2.herokuapp.com/chatbot" frameborder="0" width="100%" height="100%"
      style="border-radius: 26px;"></iframe>
  </div>

  <script>
    /* ========== Cart logic (single source of truth) ========== */
    const CART_KEY = 'sthub_cart';
    const ORDERS_KEY = 'sthub_orders';

    /* Optional: migrate any legacy key */
    (function migrateCartKey() {
      const legacy = localStorage.getItem('sth_cart');
      const current = localStorage.getItem(CART_KEY);
      if (legacy && !current) localStorage.setItem(CART_KEY, legacy);
    })();

    const money = (n) => `RS ${new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n)}`;

    /* Authentication helper functions - Updated to use global AuthManager */
    function isUserLoggedIn() {
      return window.AuthManager ? window.AuthManager.isAuthenticated() : false;
    }

    function readCart() {
      let arr = [];
      try { arr = JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch { }
      if (!Array.isArray(arr)) arr = [];
      // normalize legacy fields
      return arr.map(i => ({
        id: i.id,
        title: i.title || i.name || 'Item',
        price: Number(i.price) || 0,
        shippingCost: Number(i.shippingCost) || 0,
        img: i.img || '',
        qty: Number(i.qty) || 1
      }));
    }
    function writeCart(items) { localStorage.setItem(CART_KEY, JSON.stringify(items)); }
    function cartCount() { return readCart().reduce((n, i) => n + (i.qty || 1), 0); }
    function setCartBadge() { const el = document.getElementById('cartCount'); if (el) el.textContent = cartCount(); }

    function toggleChat() { document.getElementById('chatbot-container').classList.toggle('show'); }

    /* Render */
    function renderCart() {
      const list = document.getElementById('cartItems');
      const items = readCart();
      setCartBadge();

      if (!items.length) {
        list.innerHTML = `
      <p style="color:var(--muted)">Your cart is empty.</p>
      <a class="btn" href="index.html" style="margin-top:8px">Continue shopping</a>`;
        document.getElementById('subtotal').textContent = money(0);
        document.getElementById('shippingTotal').textContent = money(0);
        document.getElementById('grandTotal').textContent = money(0);
        return;
      }

      list.innerHTML = items.map((it, idx) => `
    <div class="cart-row">
      <img src="${it.img}" alt="" />
      <div>
        <div style="font-weight:700">${it.title}</div>
        <div class="price" style="margin-top:4px">${money(it.price)}</div>
        <div class="shipping-note" style="font-size:0.8rem; color:var(--muted); margin-top:2px">
          Shipping: ${it.shippingCost > 0 ? money(it.shippingCost) : 'Free'}
        </div>
      </div>
      <div class="qty">
        <input type="number" min="1" value="${it.qty}" data-idx="${idx}" />
      </div>
      <div class="line-total">${money((it.price * it.qty) + (it.shippingCost * it.qty))}</div>
      <button class="icon-btn" aria-label="Remove" data-remove="${idx}">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18M8 6v12m8-12v12M5 6l1-3h12l1 3M9 6h6"/></svg>
      </button>
    </div>
  `).join('');

      const subtotal = items.reduce((s, i) => s + i.price * i.qty, 0);
      const shippingTotal = items.reduce((s, i) => s + i.shippingCost * i.qty, 0);

      document.getElementById('subtotal').textContent = money(subtotal);
      document.getElementById('shippingTotal').textContent = shippingTotal > 0 ? money(shippingTotal) : 'Free';
      document.getElementById('grandTotal').textContent = money(subtotal + shippingTotal);
    }

    /* Events */
    document.addEventListener('input', (e) => {
      if (!e.target.matches('.qty input')) return;
      const idx = +e.target.dataset.idx;
      const items = readCart();
      items[idx].qty = Math.max(1, parseInt(e.target.value || '1', 10));
      writeCart(items);
      renderCart();
    });

    document.addEventListener('click', (e) => {
      const rm = e.target.closest('[data-remove]');
      if (!rm) return;
      const idx = +rm.dataset.remove;
      const items = readCart();
      items.splice(idx, 1);
      writeCart(items);
      renderCart();
    });

    document.getElementById('clearCartBtn').addEventListener('click', () => {
      writeCart([]); renderCart();
    });

    document.getElementById('processOrderBtn').addEventListener('click', () => {
      // Use global AuthManager for authentication check
      if (!window.AuthManager || !window.AuthManager.isAuthenticated()) {
        const shouldRedirect = confirm('Please sign in to proceed with checkout. Would you like to go to the login page?');
        if (shouldRedirect) {
          // Store current cart and redirect to login with return URL
          window.location.href = 'auth.html?mode=signin&redirect=' + encodeURIComponent('checkout.html');
        }
        return;
      }

      // Go to escrow checkout
      location.href = 'checkout.html';
    });

    /* init */
    renderCart();
    syncCartWithFirebase();

    async function syncCartWithFirebase() {
      const items = readCart();
      if (!items.length) return;

      let updated = false;
      const db = firebase.database();

      // Check each item
      const promises = items.map(async (item, idx) => {
        // Only fetch if shippingCost is missing or 0 (to be safe, though 0 might be valid)
        // To avoid excessive reads, we could check if it's explicitly undefined in the raw data, 
        // but readCart normalizes it. 
        // Let's just fetch all items to ensure price and shipping are up to date.
        try {
          const snap = await db.ref('products/' + item.id).once('value');
          if (snap.exists()) {
            const p = snap.val();
            const shipping = parseFloat(p.shippingCost) || 0;
            const price = parseFloat(p.price) || 0;

            // Update if different
            if (item.shippingCost !== shipping || item.price !== price) {
              items[idx].shippingCost = shipping;
              items[idx].price = price; // Also update price while we're at it
              updated = true;
            }
          }
        } catch (e) {
          console.error('Error syncing item:', item.id, e);
        }
      });

      await Promise.all(promises);

      if (updated) {
        writeCart(items);
        renderCart();
        console.log('?? Cart updated with latest data from Firebase');
      }
    }
  </script>
</body>

</html>
