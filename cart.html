﻿﻿﻿﻿﻿﻿<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Safe Trade Hub – Cart</title>
  <link rel="stylesheet" href="style.css" />
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <!-- Firebase Configuration -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBK-1VZZImDnjmRCXBEzyLAq6AthTZ8yIs",
      authDomain: "safe-trade-hub-a57cb.firebaseapp.com",
      projectId: "safe-trade-hub-a57cb",
      storageBucket: "safe-trade-hub-a57cb.appspot.com",
      messagingSenderId: "509522351934",
      appId: "1:509522351934:web:a9f5624cded8f7a6d93e6f",
      measurementId: "G-060FYYP5DD"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  
  <!-- Load authentication system -->
  <script src="js/auth-manager.js"></script>
  <script src="js/header-manager.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo" aria-label="Safe Trade Hub Home">SafeTradeHub</a>

      <nav class="header-actions" aria-label="Top actions">
        <!-- Navigation will be updated by HeaderManager -->
      </nav>
    </div>
  </header>

  <!-- Cart -->
  <section class="section cart-wrap">
    <div class="container">
      <h1 style="margin:0 0 16px">Your Cart</h1>

      <div class="cart-grid">
        <!-- Items -->
        <div class="cart-card">
          <div id="cartItems"></div>
          <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
            <button class="btn clear-btn" id="clearCartBtn">Clear Cart</button>
          </div>
        </div>

        <!-- Summary -->
        <aside class="cart-card summary" aria-label="Order summary">
          <h3 style="margin:0 0 8px">Summary</h3>
          <div class="total-line"><span>Subtotal</span><strong id="subtotal">—</strong></div>
          <div class="total-line"><span>Shipping</span><span>Free</span></div>
          <hr style="border:none;border-top:1px solid #eef1f6; margin:8px 0">
          <div class="total-line" style="font-size:1.1rem"><span>Total</span><strong id="grandTotal">—</strong></div>
          <button class="btn primary" id="processOrderBtn">Proceed to Checkout</button>
          <p class="muted-note" style="color:var(--muted); font-size:.9rem; margin-top:8px">
            * MVP: creates a local order and clears the cart.
          </p>
        </aside>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container">
      <p>All Rights Reserved By Safe Trade Hub</p>
    </div>
  </footer>

  <!-- Chat container -->
  <div id="chatbot-container" class="chatbot-container">
    <iframe src="https://safetradehub-d797d24354d2.herokuapp.com/chatbot" frameborder="0" width="100%" height="100%" style="border-radius: 26px;"></iframe>
  </div>

<script>
/* ========== Cart logic (single source of truth) ========== */
const CART_KEY   = 'sthub_cart';
const ORDERS_KEY = 'sthub_orders';

/* Optional: migrate any legacy key */
(function migrateCartKey(){
  const legacy = localStorage.getItem('sth_cart');
  const current = localStorage.getItem(CART_KEY);
  if (legacy && !current) localStorage.setItem(CART_KEY, legacy);
})();

const money = (n) => new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' }).format(n);

/* Authentication helper functions - Updated to use global AuthManager */
function isUserLoggedIn() {
  return window.AuthManager ? window.AuthManager.isAuthenticated() : false;
}

function readCart(){
  let arr = [];
  try { arr = JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch {}
  if (!Array.isArray(arr)) arr = [];
  // normalize legacy fields
  return arr.map(i => ({
    id: i.id,
    title: i.title || i.name || 'Item',
    price: Number(i.price) || 0,
    img: i.img || '',
    qty: Number(i.qty) || 1
  }));
}
function writeCart(items){ localStorage.setItem(CART_KEY, JSON.stringify(items)); }
function cartCount(){ return readCart().reduce((n,i)=> n + (i.qty || 1), 0); }
function setCartBadge(){ const el = document.getElementById('cartCount'); if (el) el.textContent = cartCount(); }

function toggleChat(){ document.getElementById('chatbot-container').classList.toggle('show'); }

/* Render */
function renderCart(){
  const list = document.getElementById('cartItems');
  const items = readCart();
  setCartBadge();

  if(!items.length){
    list.innerHTML = `
      <p style="color:var(--muted)">Your cart is empty.</p>
      <a class="btn" href="index.html" style="margin-top:8px">Continue shopping</a>`;
    document.getElementById('subtotal').textContent   = money(0);
    document.getElementById('grandTotal').textContent = money(0);
    return;
  }

  list.innerHTML = items.map((it, idx) => `
    <div class="cart-row">
      <img src="${it.img}" alt="" />
      <div>
        <div style="font-weight:700">${it.title}</div>
        <div class="price" style="margin-top:4px">${money(it.price)}</div>
      </div>
      <div class="qty">
        <input type="number" min="1" value="${it.qty}" data-idx="${idx}" />
      </div>
      <div class="line-total">${money(it.price * it.qty)}</div>
      <button class="icon-btn" aria-label="Remove" data-remove="${idx}">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18M8 6v12m8-12v12M5 6l1-3h12l1 3M9 6h6"/></svg>
      </button>
    </div>
  `).join('');

  const subtotal = items.reduce((s,i)=> s + i.price * i.qty, 0);
  document.getElementById('subtotal').textContent   = money(subtotal);
  document.getElementById('grandTotal').textContent = money(subtotal);
}

/* Events */
document.addEventListener('input', (e) => {
  if(!e.target.matches('.qty input')) return;
  const idx   = +e.target.dataset.idx;
  const items = readCart();
  items[idx].qty = Math.max(1, parseInt(e.target.value || '1', 10));
  writeCart(items);
  renderCart();
});

document.addEventListener('click', (e) => {
  const rm = e.target.closest('[data-remove]');
  if(!rm) return;
  const idx   = +rm.dataset.remove;
  const items = readCart();
  items.splice(idx, 1);
  writeCart(items);
  renderCart();
});

document.getElementById('clearCartBtn').addEventListener('click', ()=>{
  writeCart([]); renderCart();
});

document.getElementById('processOrderBtn').addEventListener('click', ()=>{
  // Use global AuthManager for authentication check
  if (!window.AuthManager || !window.AuthManager.isAuthenticated()) {
    const shouldRedirect = confirm('Please sign in to proceed with checkout. Would you like to go to the login page?');
    if (shouldRedirect) {
      // Store current cart and redirect to login with return URL
      window.location.href = 'auth.html?mode=signin&redirect=' + encodeURIComponent('checkout.html');
    }
    return;
  }
  
  // Go to escrow checkout
  location.href = 'checkout.html';
});

/* init */
renderCart();
</script>
</body>
</html>
