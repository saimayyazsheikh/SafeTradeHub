<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debug SafeTradeHub</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  
  <!-- Firebase Configuration -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBK-1VZZImDnjmRCXBEzyLAq6AthTZ8yIs",
      authDomain: "safe-trade-hub-a57cb.firebaseapp.com",
      projectId: "safe-trade-hub-a57cb",
      storageBucket: "safe-trade-hub-a57cb.appspot.com",
      messagingSenderId: "509522351934",
      appId: "1:509522351934:web:a9f5624cded8f7a6d93e6f",
      measurementId: "G-060FYYP5DD"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  
  <script src="js/auth-manager.js"></script>
  <script src="js/header-manager.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="logo">SafeTradeHub</a>
      <nav class="header-actions">
        <!-- Chat -->
        <button class="icon-btn" onclick="toggleChat()">Chat</button>
        <!-- Notification -->
        <button class="icon-btn" onclick="requestNotificationPermission()">Notification</button>
        <!-- Navigation will be updated by HeaderManager -->
      </nav>
    </div>
  </header>

  <div style="padding: 20px;">
    <h1>Authentication Debug & Testing</h1>
    <div id="debug-info"></div>
    
    <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
      <button onclick="testAuth()">Test Authentication</button>
      <button onclick="testLogin()">Simulate Login</button>
      <button onclick="testLogout()">Test Logout</button>
      <button onclick="testCartAdd()">Test Add to Cart</button>
      <button onclick="testCompleteWorkflow()">Test Complete Workflow</button>
    </div>
    
    <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
      <a href="wallet.html" target="_blank" style="padding: 10px; background: #007bff; color: white; text-decoration: none; border-radius: 5px;">Test Wallet Access</a>
      <a href="dashboard.html" target="_blank" style="padding: 10px; background: #28a745; color: white; text-decoration: none; border-radius: 5px;">Test Dashboard Access</a>
      <a href="cart.html" target="_blank" style="padding: 10px; background: #fd7e14; color: white; text-decoration: none; border-radius: 5px;">Test Cart Access</a>
      <a href="checkout.html" target="_blank" style="padding: 10px; background: #6f42c1; color: white; text-decoration: none; border-radius: 5px;">Test Checkout Access</a>
    </div>
    
    <div id="workflow-results" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;"></div>
  </div>

  <script>
    // Debug logging
    console.log('=== DEBUG START ===');
    console.log('window.AuthManager exists:', !!window.AuthManager);
    console.log('window.HeaderManager exists:', !!window.HeaderManager);

    function updateDebugInfo() {
      const debugEl = document.getElementById('debug-info');
      const authManager = window.AuthManager;
      
      let authManagerState = 'Not Available';
      let authManagerAuth = false;
      let authManagerUser = null;
      
      if (authManager) {
        try {
          authManagerAuth = authManager.isAuthenticated();
          authManagerUser = authManager.getCurrentUser();
          authManagerState = 'Available & Working';
        } catch (error) {
          authManagerState = 'Available but Error: ' + error.message;
        }
      }
      
      // Test cart authentication
      let cartAuthResult = 'Function not available';
      if (typeof isUserAuthenticated === 'function') {
        try {
          cartAuthResult = isUserAuthenticated();
        } catch (error) {
          cartAuthResult = 'Error: ' + error.message;
        }
      }
      
      debugEl.innerHTML = `
        <div style="background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px;">
          <h3>Authentication State Debug</h3>
          <p><strong>AuthManager Status:</strong> ${authManagerState}</p>
          <p><strong>AuthManager isAuthenticated():</strong> ${authManagerAuth}</p>
          <p><strong>AuthManager User:</strong> ${authManagerUser ? JSON.stringify(authManagerUser, null, 2) : 'null'}</p>
          <p><strong>Cart Auth Check Result:</strong> ${cartAuthResult}</p>
          <p><strong>LocalStorage userData:</strong> ${localStorage.getItem('userData') || 'null'}</p>
          <p><strong>LocalStorage authToken:</strong> ${localStorage.getItem('authToken') || 'null'}</p>
          <p><strong>Firebase Current User:</strong> ${(typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) ? firebase.auth().currentUser.email : 'null'}</p>
        </div>
      `;
    }

    function testAuth() {
      console.log('Testing auth...');
      updateDebugInfo();
    }

    function testLogin() {
      console.log('Simulating login...');
      // Simulate a successful login with proper provider
      const testUser = {
        id: 'test123',
        uid: 'test123',
        name: 'Test User',
        email: 'test@example.com',
        role: 'Buyer',
        provider: 'test' // This will make it work with new auth logic
      };
      
      // Store in localStorage first
      localStorage.setItem('userData', JSON.stringify(testUser));
      localStorage.setItem('authToken', 'test-token-123');
      
      // Then update AuthManager
      if (window.AuthManager) {
        window.AuthManager.setAuthData(testUser, 'test-token-123');
        console.log('‚úÖ AuthManager updated with test user');
      } else {
        console.warn('‚ö†Ô∏è AuthManager not available');
      }
      
      updateDebugInfo();
      alert('‚úÖ Login simulation complete! Authentication should now work across all pages.');
    }

    function testLogout() {
      console.log('Testing logout...');
      
      // Check if there are items in cart before logout
      const cartBefore = localStorage.getItem('sthub_cart');
      const cartCountBefore = cartBefore ? JSON.parse(cartBefore).length : 0;
      
      console.log('üõí Cart items before logout:', cartCountBefore);
      
      if (window.AuthManager) {
        window.AuthManager.clearAuth();
      }
      
      // Check cart after logout
      const cartAfter = localStorage.getItem('sthub_cart');
      const cartCountAfter = cartAfter ? JSON.parse(cartAfter).length : 0;
      
      console.log('üõí Cart items after logout:', cartCountAfter);
      
      updateDebugInfo();
      
      if (cartCountAfter === 0) {
        alert('‚úÖ Logout successful! Cart was automatically cleared.');
      } else {
        alert('‚ö†Ô∏è Logout completed, but cart may not have been cleared properly.');
      }
    }

    async function testCompleteWorkflow() {
      const resultsDiv = document.getElementById('workflow-results');
      resultsDiv.innerHTML = '<h3>Testing Complete Workflow...</h3>';
      
      const results = [];
      
      try {
        // Step 1: Test Authentication
        results.push('üîê Testing Authentication...');
        const isAuth = isUserAuthenticated ? isUserAuthenticated() : false;
        results.push(`   Authentication Result: ${isAuth ? '‚úÖ AUTHENTICATED' : '‚ùå NOT AUTHENTICATED'}`);
        
        // Step 2: Test AuthManager
        results.push('üéØ Testing AuthManager...');
        if (window.AuthManager) {
          const authManagerResult = window.AuthManager.isAuthenticated();
          const user = window.AuthManager.getCurrentUser();
          results.push(`   AuthManager Result: ${authManagerResult ? '‚úÖ AUTHENTICATED' : '‚ùå NOT AUTHENTICATED'}`);
          results.push(`   User Data: ${user ? `‚úÖ ${user.name || user.email}` : '‚ùå NO USER'}`);
        } else {
          results.push('   ‚ùå AuthManager NOT AVAILABLE');
        }
        
        // Step 3: Test localStorage
        results.push('üíæ Testing localStorage...');
        const userData = localStorage.getItem('userData');
        const authToken = localStorage.getItem('authToken');
        results.push(`   UserData: ${userData ? '‚úÖ EXISTS' : '‚ùå MISSING'}`);
        results.push(`   AuthToken: ${authToken ? '‚úÖ EXISTS' : '‚ùå MISSING'}`);
        
        // Step 4: Test Cart Function
        results.push('üõí Testing Cart Function...');
        if (typeof addToCart === 'function') {
          results.push('   ‚úÖ addToCart function available');
          // Test the actual function
          const testProduct = {
            id: 'test-workflow-product',
            title: 'Workflow Test Product',
            price: 1.00,
            img: 'test.jpg'
          };
          
          try {
            const cartResult = addToCart(testProduct, 1);
            results.push(`   Cart Add Result: ${cartResult ? '‚úÖ SUCCESS' : '‚ùå FAILED'}`);
          } catch (cartError) {
            results.push(`   ‚ùå Cart Add Error: ${cartError.message}`);
          }
        } else {
          results.push('   ‚ùå addToCart function NOT AVAILABLE');
        }
        
        // Step 5: Test Header State
        results.push('üé® Testing Header State...');
        const headerActions = document.querySelector('.header-actions');
        if (headerActions) {
          const signInLink = headerActions.querySelector('a[href*="auth.html"]');
          const userMenu = headerActions.querySelector('.user-menu');
          results.push(`   Header Sign In Link: ${signInLink ? '‚ùå VISIBLE (should be hidden when logged in)' : '‚úÖ HIDDEN'}`);
          results.push(`   Header User Menu: ${userMenu ? '‚úÖ VISIBLE' : '‚ùå HIDDEN (should be visible when logged in)'}`);
        } else {
          results.push('   ‚ùå Header actions not found');
        }
        
        // Final Assessment
        results.push('');
        results.push('üìä FINAL ASSESSMENT:');
        if (isAuth && window.AuthManager?.isAuthenticated() && userData) {
          results.push('   ‚úÖ AUTHENTICATION IS WORKING CORRECTLY');
          results.push('   ‚úÖ You should be able to add items to cart');
          results.push('   ‚úÖ You should be able to access wallet and dashboard');
        } else {
          results.push('   ‚ùå AUTHENTICATION IS NOT WORKING');
          results.push('   ‚ùå You will get login prompts when adding to cart');
          results.push('   ‚ùå Wallet and dashboard will redirect to login');
        }
        
      } catch (error) {
        results.push(`‚ùå Workflow test error: ${error.message}`);
      }
      
      resultsDiv.innerHTML = '<h3>Workflow Test Results:</h3><pre>' + results.join('\n') + '</pre>';
      updateDebugInfo();
    }

    function testCartAdd() {
      console.log('Testing cart add functionality...');
      
      // Create a test product
      const testProduct = {
        id: 'test-product-123',
        title: 'Test Product',
        price: 9.99,
        img: 'images/test.jpg'
      };
      
      // Test the cart authentication and add function
      if (typeof addToCart === 'function') {
        const result = addToCart(testProduct, 1);
        console.log('Cart add result:', result);
        updateDebugInfo();
        alert(result ? '‚úÖ Cart add successful!' : '‚ùå Cart add failed!');
      } else {
        alert('‚ùå addToCart function not available on this page');
      }
    }

    function toggleChat() {
      console.log('Chat button clicked');
      alert('Chat button works!');
    }

    function requestNotificationPermission() {
      console.log('Notification button clicked');
      alert('Notification button works!');
    }

    // Initialize debug info after page loads
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        updateDebugInfo();
        console.log('Debug page loaded and initialized');
      }, 1000);
    });
  </script>
</body>
</html>